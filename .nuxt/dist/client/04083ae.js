(window.webpackJsonp=window.webpackJsonp||[]).push([[1],{386:function(t,e,o){t.exports=function t(e,o,n){function s(r,u){if(!o[r]){if(!e[r]){if(i)return i(r,!0);throw new Error("Cannot find module '"+r+"'")}var l=o[r]={exports:{}};e[r][0].call(l.exports,(function(t){var o=e[r][1][t];return s(o||t)}),l,l.exports,t,e,o,n)}return o[r].exports}for(var i=!1,r=0;r<n.length;r++)s(n[r]);return s}({1:[function(t,e,o){e.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(t,e,o){e.exports={version:t("../package.json").version,AABB:t("./collision/AABB"),ArrayCollisionMatrix:t("./collision/ArrayCollisionMatrix"),Body:t("./objects/Body"),Box:t("./shapes/Box"),Broadphase:t("./collision/Broadphase"),Constraint:t("./constraints/Constraint"),ContactEquation:t("./equations/ContactEquation"),Narrowphase:t("./world/Narrowphase"),ConeTwistConstraint:t("./constraints/ConeTwistConstraint"),ContactMaterial:t("./material/ContactMaterial"),ConvexPolyhedron:t("./shapes/ConvexPolyhedron"),Cylinder:t("./shapes/Cylinder"),DistanceConstraint:t("./constraints/DistanceConstraint"),Equation:t("./equations/Equation"),EventTarget:t("./utils/EventTarget"),FrictionEquation:t("./equations/FrictionEquation"),GSSolver:t("./solver/GSSolver"),GridBroadphase:t("./collision/GridBroadphase"),Heightfield:t("./shapes/Heightfield"),HingeConstraint:t("./constraints/HingeConstraint"),LockConstraint:t("./constraints/LockConstraint"),Mat3:t("./math/Mat3"),Material:t("./material/Material"),NaiveBroadphase:t("./collision/NaiveBroadphase"),ObjectCollisionMatrix:t("./collision/ObjectCollisionMatrix"),Pool:t("./utils/Pool"),Particle:t("./shapes/Particle"),Plane:t("./shapes/Plane"),PointToPointConstraint:t("./constraints/PointToPointConstraint"),Quaternion:t("./math/Quaternion"),Ray:t("./collision/Ray"),RaycastVehicle:t("./objects/RaycastVehicle"),RaycastResult:t("./collision/RaycastResult"),RigidVehicle:t("./objects/RigidVehicle"),RotationalEquation:t("./equations/RotationalEquation"),RotationalMotorEquation:t("./equations/RotationalMotorEquation"),SAPBroadphase:t("./collision/SAPBroadphase"),SPHSystem:t("./objects/SPHSystem"),Shape:t("./shapes/Shape"),Solver:t("./solver/Solver"),Sphere:t("./shapes/Sphere"),SplitSolver:t("./solver/SplitSolver"),Spring:t("./objects/Spring"),Trimesh:t("./shapes/Trimesh"),Vec3:t("./math/Vec3"),Vec3Pool:t("./utils/Vec3Pool"),World:t("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(t,e,o){var n=t("../math/Vec3");function r(t){t=t||{},this.lowerBound=new n,t.lowerBound&&this.lowerBound.copy(t.lowerBound),this.upperBound=new n,t.upperBound&&this.upperBound.copy(t.upperBound)}t("../utils/Utils"),e.exports=r;var l=new n;r.prototype.setFromPoints=function(t,e,o,n){var r=this.lowerBound,u=this.upperBound,q=o;r.copy(t[0]),q&&q.vmult(r,r),u.copy(r);for(var i=1;i<t.length;i++){var p=t[i];q&&(q.vmult(p,l),p=l),p.x>u.x&&(u.x=p.x),p.x<r.x&&(r.x=p.x),p.y>u.y&&(u.y=p.y),p.y<r.y&&(r.y=p.y),p.z>u.z&&(u.z=p.z),p.z<r.z&&(r.z=p.z)}return e&&(e.vadd(r,r),e.vadd(u,u)),n&&(r.x-=n,r.y-=n,r.z-=n,u.x+=n,u.y+=n,u.z+=n),this},r.prototype.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},r.prototype.clone=function(){return(new r).copy(this)},r.prototype.extend=function(t){var e=t.lowerBound.x;this.lowerBound.x>e&&(this.lowerBound.x=e);var u=t.upperBound.x;this.upperBound.x<u&&(this.upperBound.x=u),e=t.lowerBound.y,this.lowerBound.y>e&&(this.lowerBound.y=e),u=t.upperBound.y,this.upperBound.y<u&&(this.upperBound.y=u),e=t.lowerBound.z,this.lowerBound.z>e&&(this.lowerBound.z=e),u=t.upperBound.z,this.upperBound.z<u&&(this.upperBound.z=u)},r.prototype.overlaps=function(t){var e=this.lowerBound,o=this.upperBound,n=t.lowerBound,r=t.upperBound;return(n.x<=o.x&&o.x<=r.x||e.x<=r.x&&r.x<=o.x)&&(n.y<=o.y&&o.y<=r.y||e.y<=r.y&&r.y<=o.y)&&(n.z<=o.z&&o.z<=r.z||e.z<=r.z&&r.z<=o.z)},r.prototype.contains=function(t){var e=this.lowerBound,o=this.upperBound,n=t.lowerBound,r=t.upperBound;return e.x<=n.x&&o.x>=r.x&&e.y<=n.y&&o.y>=r.y&&e.z<=n.z&&o.z>=r.z},r.prototype.getCorners=function(a,b,t,e,o,n,g,r){var l=this.lowerBound,u=this.upperBound;a.copy(l),b.set(u.x,l.y,l.z),t.set(u.x,u.y,l.z),e.set(l.x,u.y,u.z),o.set(u.x,l.y,l.z),n.set(l.x,u.y,l.z),g.set(l.x,l.y,u.z),r.copy(u)};var h=[new n,new n,new n,new n,new n,new n,new n,new n];r.prototype.toLocalFrame=function(t,e){var o=h,a=o[0],b=o[1],n=o[2],r=o[3],l=o[4],c=o[5],g=o[6],d=o[7];this.getCorners(a,b,n,r,l,c,g,d);for(var i=0;8!==i;i++){var v=o[i];t.pointToLocal(v,v)}return e.setFromPoints(o)},r.prototype.toWorldFrame=function(t,e){var o=h,a=o[0],b=o[1],n=o[2],r=o[3],l=o[4],c=o[5],g=o[6],d=o[7];this.getCorners(a,b,n,r,l,c,g,d);for(var i=0;8!==i;i++){var v=o[i];t.pointToWorld(v,v)}return e.setFromPoints(o)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(t,e,o){function n(){this.matrix=[]}e.exports=n,n.prototype.get=function(i,t){if(i=i.index,(t=t.index)>i){var e=t;t=i,i=e}return this.matrix[(i*(i+1)>>1)+t-1]},n.prototype.set=function(i,t,e){if(i=i.index,(t=t.index)>i){var o=t;t=i,i=o}this.matrix[(i*(i+1)>>1)+t-1]=e?1:0},n.prototype.reset=function(){for(var i=0,t=this.matrix.length;i!==t;i++)this.matrix[i]=0},n.prototype.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1}},{}],5:[function(t,e,o){var n=t("../objects/Body"),r=t("../math/Vec3"),l=t("../math/Quaternion");function h(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}t("../shapes/Shape"),t("../shapes/Plane"),e.exports=h,h.prototype.collisionPairs=function(t,e,o){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var c=n.STATIC|n.KINEMATIC;h.prototype.needBroadphaseCollision=function(t,e){return 0!=(t.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&t.collisionFilterMask)&&(0==(t.type&c)&&t.sleepState!==n.SLEEPING||0==(e.type&c)&&e.sleepState!==n.SLEEPING)},h.prototype.intersectionTest=function(t,e,o,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,o,n):this.doBoundingSphereBroadphase(t,e,o,n)};var d=new r;new r,new l,new r,h.prototype.doBoundingSphereBroadphase=function(t,e,o,n){var r=d;e.position.vsub(t.position,r);var l=Math.pow(t.boundingRadius+e.boundingRadius,2);r.norm2()<l&&(o.push(t),n.push(e))},h.prototype.doBoundingBoxBroadphase=function(t,e,o,n){t.aabbNeedsUpdate&&t.computeAABB(),e.aabbNeedsUpdate&&e.computeAABB(),t.aabb.overlaps(e.aabb)&&(o.push(t),n.push(e))};var v={keys:[]},y=[],f=[];h.prototype.makePairsUnique=function(t,e){for(var o=v,n=y,r=f,l=t.length,i=0;i!==l;i++)n[i]=t[i],r[i]=e[i];for(t.length=0,e.length=0,i=0;i!==l;i++){var h=n[i].id,c=r[i].id;o[d=h<c?h+","+c:c+","+h]=i,o.keys.push(d)}for(i=0;i!==o.keys.length;i++){var d=o.keys.pop(),m=o[d];t.push(n[m]),e.push(r[m]),delete o[d]}},h.prototype.setWorld=function(t){};var m=new r;h.boundingSphereCheck=function(t,e){var o=m;return t.position.vsub(e.position,o),Math.pow(t.shape.boundingSphereRadius+e.shape.boundingSphereRadius,2)>o.norm2()},h.prototype.aabbQuery=function(t,e,o){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(t,e,o){e.exports=h;var n=t("./Broadphase"),r=t("../math/Vec3"),l=t("../shapes/Shape");function h(t,e,o,l,h){n.apply(this),this.nx=o||10,this.ny=l||10,this.nz=h||10,this.aabbMin=t||new r(100,100,100),this.aabbMax=e||new r(-100,-100,-100);var c=this.nx*this.ny*this.nz;if(c<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=c,this.binLengths.length=c;for(var i=0;i<c;i++)this.bins[i]=[],this.binLengths[i]=0}h.prototype=new n,h.prototype.constructor=h;var c=new r;new r,h.prototype.collisionPairs=function(t,e,o){for(var n=t.numObjects(),r=t.bodies,h=this.aabbMax,d=this.aabbMin,v=this.nx,y=this.ny,f=this.nz,m=y*f,w=f,x=1,B=h.x,E=h.y,A=h.z,S=d.x,C=d.y,z=d.z,R=v/(B-S),M=y/(E-C),P=f/(A-z),F=(B-S)/v,V=(E-C)/y,T=(A-z)/f,N=.5*Math.sqrt(F*F+V*V+T*T),I=l.types,W=I.SPHERE,L=I.PLANE,j=(I.BOX,I.COMPOUND,I.CONVEXPOLYHEDRON,this.bins),O=this.binLengths,k=this.bins.length,i=0;i!==k;i++)O[i]=0;var _=Math.ceil;function U(t,e,o,n,r,l,h){var c=(t-S)*R|0,d=(e-C)*M|0,B=(o-z)*P|0,E=_((n-S)*R),A=_((r-C)*M),F=_((l-z)*P);c<0?c=0:c>=v&&(c=v-1),d<0?d=0:d>=y&&(d=y-1),B<0?B=0:B>=f&&(B=f-1),E<0?E=0:E>=v&&(E=v-1),A<0?A=0:A>=y&&(A=y-1),F<0?F=0:F>=f&&(F=f-1),d*=w,B*=x,E*=m,A*=w,F*=x;for(var V=c*=m;V<=E;V+=m)for(var T=d;T<=A;T+=w)for(var N=B;N<=F;N+=x){var I=V+T+N;j[I][O[I]++]=h}}for(d=Math.min,h=Math.max,i=0;i!==n;i++){var H=(pt=r[i]).shape;switch(H.type){case W:var D=pt.position.x,X=pt.position.y,G=pt.position.z,Y=H.radius;U(D-Y,X-Y,G-Y,D+Y,X+Y,G+Y,pt);break;case L:H.worldNormalNeedsUpdate&&H.computeWorldNormal(pt.quaternion);var Q=H.worldNormal,Z=S+.5*F-pt.position.x,K=C+.5*V-pt.position.y,J=z+.5*T-pt.position.z,$=c;$.set(Z,K,J);for(var tt=0,et=0;tt!==v;tt++,et+=m,$.y=K,$.x+=F)for(var ot=0,it=0;ot!==y;ot++,it+=w,$.z=J,$.y+=V)for(var nt=0,st=0;nt!==f;nt++,st+=x,$.z+=T)if($.dot(Q)<N){var at=et+it+st;j[at][O[at]++]=pt}break;default:pt.aabbNeedsUpdate&&pt.computeAABB(),U(pt.aabb.lowerBound.x,pt.aabb.lowerBound.y,pt.aabb.lowerBound.z,pt.aabb.upperBound.x,pt.aabb.upperBound.y,pt.aabb.upperBound.z,pt)}}for(i=0;i!==k;i++){var lt=O[i];if(lt>1){var ht=j[i];for(tt=0;tt!==lt;tt++){var pt=ht[tt];for(ot=0;ot!==tt;ot++){var ct=ht[ot];this.needBroadphaseCollision(pt,ct)&&this.intersectionTest(pt,ct,e,o)}}}}this.makePairsUnique(e,o)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(t,e,o){e.exports=l;var n=t("./Broadphase"),r=t("./AABB");function l(){n.apply(this)}l.prototype=new n,l.prototype.constructor=l,l.prototype.collisionPairs=function(t,e,o){var i,n,r,l,h=t.bodies,c=h.length;for(i=0;i!==c;i++)for(n=0;n!==i;n++)r=h[i],l=h[n],this.needBroadphaseCollision(r,l)&&this.intersectionTest(r,l,e,o)},new r,l.prototype.aabbQuery=function(t,e,o){o=o||[];for(var i=0;i<t.bodies.length;i++){var b=t.bodies[i];b.aabbNeedsUpdate&&b.computeAABB(),b.aabb.overlaps(e)&&o.push(b)}return o}},{"./AABB":3,"./Broadphase":5}],8:[function(t,e,o){function n(){this.matrix={}}e.exports=n,n.prototype.get=function(i,t){if(i=i.id,(t=t.id)>i){var e=t;t=i,i=e}return i+"-"+t in this.matrix},n.prototype.set=function(i,t,e){if(i=i.id,(t=t.id)>i){var o=t;t=i,i=o}e?this.matrix[i+"-"+t]=!0:delete this.matrix[i+"-"+t]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(t){}},{}],9:[function(t,e,o){e.exports=v;var n=t("../math/Vec3"),r=t("../math/Quaternion"),l=t("../math/Transform"),h=(t("../shapes/ConvexPolyhedron"),t("../shapes/Box"),t("../collision/RaycastResult")),c=t("../shapes/Shape"),d=t("../collision/AABB");function v(t,e){this.from=t?t.clone():new n,this.to=e?e.clone():new n,this._direction=new n,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=v.ANY,this.result=new h,this.hasHit=!1,this.callback=function(t){}}v.prototype.constructor=v,v.CLOSEST=1,v.ANY=2,v.ALL=4;var y=new d,f=[];v.prototype.intersectWorld=function(t,e){return this.mode=e.mode||v.ANY,this.result=e.result||new h,this.skipBackfaces=!!e.skipBackfaces,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:-1,e.from&&this.from.copy(e.from),e.to&&this.to.copy(e.to),this.callback=e.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(y),f.length=0,t.broadphase.aabbQuery(t,y,f),this.intersectBodies(f),this.hasHit};var m=new n,w=new n;function x(p,a,b,t){t.vsub(a,O),b.vsub(a,m),p.vsub(a,w);var u,e,o=O.dot(O),n=O.dot(m),r=O.dot(w),l=m.dot(m),h=m.dot(w);return(u=l*r-n*h)>=0&&(e=o*h-n*r)>=0&&u+e<o*l-n*n}v.pointInTriangle=x;var B=new n,E=new r;v.prototype.intersectBody=function(body,t){t&&(this.result=t,this._updateDirection());var e=this.checkCollisionResponse;if((!e||body.collisionResponse)&&0!=(this.collisionFilterGroup&body.collisionFilterMask)&&0!=(body.collisionFilterGroup&this.collisionFilterMask))for(var o=B,n=E,i=0,r=body.shapes.length;i<r;i++){var l=body.shapes[i];if((!e||l.collisionResponse)&&(body.quaternion.mult(body.shapeOrientations[i],n),body.quaternion.vmult(body.shapeOffsets[i],o),o.vadd(body.position,o),this.intersectShape(l,n,o,body),this.result._shouldStop))break}},v.prototype.intersectBodies=function(t,e){e&&(this.result=e,this._updateDirection());for(var i=0,o=t.length;!this.result._shouldStop&&i<o;i++)this.intersectBody(t[i])},v.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},v.prototype.intersectShape=function(t,e,o,body){if(!(_(this.from,this._direction,o)>t.boundingSphereRadius)){var n=this[t.type];n&&n.call(this,t,e,o,body)}},new n,new n;var A=new n,a=new n,b=new n,S=new n;new n,new h,v.prototype.intersectBox=function(t,e,o,body){return this.intersectConvex(t.convexPolyhedronRepresentation,e,o,body)},v.prototype[c.types.BOX]=v.prototype.intersectBox,v.prototype.intersectPlane=function(t,e,o,body){var r=this.from,l=this.to,h=this._direction,c=new n(0,0,1);e.vmult(c,c);var d=new n;r.vsub(o,d);var v=d.dot(c);if(l.vsub(o,d),!(v*d.dot(c)>0||r.distanceTo(l)<v)){var y=c.dot(h);if(!(Math.abs(y)<this.precision)){var f=new n,m=new n,w=new n;r.vsub(o,f);var x=-c.dot(f)/y;h.scale(x,m),r.vadd(m,w),this.reportIntersection(c,w,t,body,-1)}}},v.prototype[c.types.PLANE]=v.prototype.intersectPlane,v.prototype.getAABB=function(t){var e=this.to,o=this.from;t.lowerBound.x=Math.min(e.x,o.x),t.lowerBound.y=Math.min(e.y,o.y),t.lowerBound.z=Math.min(e.z,o.z),t.upperBound.x=Math.max(e.x,o.x),t.upperBound.y=Math.max(e.y,o.y),t.upperBound.z=Math.max(e.z,o.z)};var C={faceList:[0]};v.prototype.intersectHeightfield=function(t,e,o,body){t.data,t.elementSize;var r=new n,h=new v(this.from,this.to);l.pointToLocalFrame(o,e,h.from,h.from),l.pointToLocalFrame(o,e,h.to,h.to);var c=[],d=null,y=null,f=null,m=null,w=t.getIndexOfPosition(h.from.x,h.from.y,c,!1);if(w&&(d=c[0],y=c[1],f=c[0],m=c[1]),(w=t.getIndexOfPosition(h.to.x,h.to.y,c,!1))&&((null===d||c[0]<d)&&(d=c[0]),(null===f||c[0]>f)&&(f=c[0]),(null===y||c[1]<y)&&(y=c[1]),(null===m||c[1]>m)&&(m=c[1])),null!==d){var x=[];t.getRectMinMax(d,y,f,m,x),x[0],x[1];for(var i=d;i<=f;i++)for(var B=y;B<=m;B++){if(this.result._shouldStop)return;if(t.getConvexTrianglePillar(i,B,!1),l.pointToWorldFrame(o,e,t.pillarOffset,r),this.intersectConvex(t.pillarConvex,e,r,body,C),this.result._shouldStop)return;t.getConvexTrianglePillar(i,B,!0),l.pointToWorldFrame(o,e,t.pillarOffset,r),this.intersectConvex(t.pillarConvex,e,r,body,C)}}},v.prototype[c.types.HEIGHTFIELD]=v.prototype.intersectHeightfield;var z=new n,R=new n;v.prototype.intersectSphere=function(t,e,o,body){var n=this.from,r=this.to,l=t.radius,a=Math.pow(r.x-n.x,2)+Math.pow(r.y-n.y,2)+Math.pow(r.z-n.z,2),b=2*((r.x-n.x)*(n.x-o.x)+(r.y-n.y)*(n.y-o.y)+(r.z-n.z)*(n.z-o.z)),h=Math.pow(n.x-o.x,2)+Math.pow(n.y-o.y,2)+Math.pow(n.z-o.z,2)-Math.pow(l,2),c=Math.pow(b,2)-4*a*h,d=z,v=R;if(!(c<0))if(0===c)n.lerp(r,c,d),d.vsub(o,v),v.normalize(),this.reportIntersection(v,d,t,body,-1);else{var y=(-b-Math.sqrt(c))/(2*a),f=(-b+Math.sqrt(c))/(2*a);if(y>=0&&y<=1&&(n.lerp(r,y,d),d.vsub(o,v),v.normalize(),this.reportIntersection(v,d,t,body,-1)),this.result._shouldStop)return;f>=0&&f<=1&&(n.lerp(r,f,d),d.vsub(o,v),v.normalize(),this.reportIntersection(v,d,t,body,-1))}},v.prototype[c.types.SPHERE]=v.prototype.intersectSphere;var M=new n,P=(new n,new n,new n);v.prototype.intersectConvex=function(t,e,o,body,n){for(var r=M,l=P,h=n&&n.faceList||null,c=t.faces,d=t.vertices,v=t.faceNormals,y=this._direction,f=this.from,m=this.to,w=f.distanceTo(m),B=h?h.length:c.length,E=this.result,C=0;!E._shouldStop&&C<B;C++){var z=h?h[C]:C,R=c[z],F=v[z],q=e,V=o;l.copy(d[R[0]]),q.vmult(l,l),l.vadd(V,l),l.vsub(f,l),q.vmult(F,r);var T=y.dot(r);if(!(Math.abs(T)<this.precision)){var N=r.dot(l)/T;if(!(N<0)){y.mult(N,A),A.vadd(f,A),a.copy(d[R[0]]),q.vmult(a,a),V.vadd(a,a);for(var i=1;!E._shouldStop&&i<R.length-1;i++){b.copy(d[R[i]]),S.copy(d[R[i+1]]),q.vmult(b,b),q.vmult(S,S),V.vadd(b,b),V.vadd(S,S);var I=A.distanceTo(f);!x(A,a,b,S)&&!x(A,b,a,S)||I>w||this.reportIntersection(r,A,t,body,z)}}}}},v.prototype[c.types.CONVEXPOLYHEDRON]=v.prototype.intersectConvex;var F=new n,V=new n,T=new n,N=new n,I=new n,W=new n,L=(new d,[]),j=new l;v.prototype.intersectTrimesh=function(t,e,o,body,n){var r=F,h=L,c=j,d=P,v=V,y=T,f=N,m=W,w=I,B=(n&&n.faceList,t.indices),E=(t.vertices,t.faceNormals,this.from),C=this.to,z=this._direction;c.position.copy(o),c.quaternion.copy(e),l.vectorToLocalFrame(o,e,z,v),l.pointToLocalFrame(o,e,E,y),l.pointToLocalFrame(o,e,C,f);var R=y.distanceSquared(f);t.tree.rayQuery(this,c,h);for(var i=0,M=h.length;!this.result._shouldStop&&i!==M;i++){var O=h[i];t.getNormal(O,r),t.getVertex(B[3*O],a),a.vsub(y,d);var k=v.dot(r),_=r.dot(d)/k;if(!(_<0)){v.scale(_,A),A.vadd(y,A),t.getVertex(B[3*O+1],b),t.getVertex(B[3*O+2],S);var U=A.distanceSquared(y);!x(A,b,a,S)&&!x(A,a,b,S)||U>R||(l.vectorToWorldFrame(e,r,w),l.pointToWorldFrame(o,e,A,m),this.reportIntersection(w,m,t,body,O))}}h.length=0},v.prototype[c.types.TRIMESH]=v.prototype.intersectTrimesh,v.prototype.reportIntersection=function(t,e,o,body,n){var r=this.from,l=this.to,h=r.distanceTo(e),c=this.result;if(!(this.skipBackfaces&&t.dot(this._direction)>0))switch(c.hitFaceIndex=void 0!==n?n:-1,this.mode){case v.ALL:this.hasHit=!0,c.set(r,l,t,e,o,body,h),c.hasHit=!0,this.callback(c);break;case v.CLOSEST:(h<c.distance||!c.hasHit)&&(this.hasHit=!0,c.hasHit=!0,c.set(r,l,t,e,o,body,h));break;case v.ANY:this.hasHit=!0,c.hasHit=!0,c.set(r,l,t,e,o,body,h),c._shouldStop=!0}};var O=new n,k=new n;function _(t,e,o){o.vsub(t,O);var n=O.dot(e);return e.mult(n,k),k.vadd(t,k),o.distanceTo(k)}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(t,e,o){var n=t("../math/Vec3");function r(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}e.exports=r,r.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},r.prototype.abort=function(){this._shouldStop=!0},r.prototype.set=function(t,e,o,n,r,body,l){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(o),this.hitPointWorld.copy(n),this.shape=r,this.body=body,this.distance=l}},{"../math/Vec3":30}],11:[function(t,e,o){t("../shapes/Shape");var n=t("../collision/Broadphase");function r(t){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var e=this.axisList;this._addBodyHandler=function(t){e.push(t.body)},this._removeBodyHandler=function(t){var o=e.indexOf(t.body);-1!==o&&e.splice(o,1)},t&&this.setWorld(t)}e.exports=r,r.prototype=new n,r.prototype.setWorld=function(t){this.axisList.length=0;for(var i=0;i<t.bodies.length;i++)this.axisList.push(t.bodies[i]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0},r.insertionSortX=function(a){for(var i=1,t=a.length;i<t;i++){for(var e=a[i],o=i-1;o>=0&&!(a[o].aabb.lowerBound.x<=e.aabb.lowerBound.x);o--)a[o+1]=a[o];a[o+1]=e}return a},r.insertionSortY=function(a){for(var i=1,t=a.length;i<t;i++){for(var e=a[i],o=i-1;o>=0&&!(a[o].aabb.lowerBound.y<=e.aabb.lowerBound.y);o--)a[o+1]=a[o];a[o+1]=e}return a},r.insertionSortZ=function(a){for(var i=1,t=a.length;i<t;i++){for(var e=a[i],o=i-1;o>=0&&!(a[o].aabb.lowerBound.z<=e.aabb.lowerBound.z);o--)a[o+1]=a[o];a[o+1]=e}return a},r.prototype.collisionPairs=function(t,e,o){var i,n,l=this.axisList,h=l.length,c=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),i=0;i!==h;i++){var d=l[i];for(n=i+1;n<h;n++){var v=l[n];if(this.needBroadphaseCollision(d,v)){if(!r.checkBounds(d,v,c))break;this.intersectionTest(d,v,e,o)}}}},r.prototype.sortList=function(){for(var t=this.axisList,e=this.axisIndex,o=t.length,i=0;i!==o;i++){var n=t[i];n.aabbNeedsUpdate&&n.computeAABB()}0===e?r.insertionSortX(t):1===e?r.insertionSortY(t):2===e&&r.insertionSortZ(t)},r.checkBounds=function(t,e,o){var n,r;0===o?(n=t.position.x,r=e.position.x):1===o?(n=t.position.y,r=e.position.y):2===o&&(n=t.position.z,r=e.position.z);var l=t.boundingRadius,h=e.boundingRadius;return r-h<n+l},r.prototype.autoDetectAxis=function(){for(var t=0,e=0,o=0,n=0,r=0,l=0,h=this.axisList,c=h.length,d=1/c,i=0;i!==c;i++){var b=h[i],v=b.position.x;t+=v,e+=v*v;var y=b.position.y;o+=y,n+=y*y;var f=b.position.z;r+=f,l+=f*f}var m=e-t*t*d,w=n-o*o*d,x=l-r*r*d;this.axisIndex=m>w?m>x?0:2:w>x?1:2},r.prototype.aabbQuery=function(t,e,o){o=o||[],this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,r="x";1===n&&(r="y"),2===n&&(r="z");for(var l=this.axisList,i=(e.lowerBound[r],e.upperBound[r],0);i<l.length;i++){var b=l[i];b.aabbNeedsUpdate&&b.computeAABB(),b.aabb.overlaps(e)&&o.push(b)}return o}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(t,e,o){e.exports=c,t("./Constraint");var n=t("./PointToPointConstraint"),r=t("../equations/ConeEquation"),l=t("../equations/RotationalEquation"),h=(t("../equations/ContactEquation"),t("../math/Vec3"));function c(t,e,o){var c=void 0!==(o=o||{}).maxForce?o.maxForce:1e6,d=o.pivotA?o.pivotA.clone():new h,v=o.pivotB?o.pivotB.clone():new h;this.axisA=o.axisA?o.axisA.clone():new h,this.axisB=o.axisB?o.axisB.clone():new h,n.call(this,t,d,e,v,c),this.collideConnected=!!o.collideConnected,this.angle=void 0!==o.angle?o.angle:0;var y=this.coneEquation=new r(t,e,o),f=this.twistEquation=new l(t,e,o);this.twistAngle=void 0!==o.twistAngle?o.twistAngle:0,y.maxForce=0,y.minForce=-c,f.maxForce=0,f.minForce=-c,this.equations.push(y,f)}c.prototype=new n,c.constructor=c,new h,new h,c.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.coneEquation,r=this.twistEquation;n.prototype.update.call(this),t.vectorToWorldFrame(this.axisA,o.axisA),e.vectorToWorldFrame(this.axisB,o.axisB),this.axisA.tangents(r.axisA,r.axisA),t.vectorToWorldFrame(r.axisA,r.axisA),this.axisB.tangents(r.axisB,r.axisB),e.vectorToWorldFrame(r.axisB,r.axisB),o.angle=this.angle,r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(t,e,o){e.exports=r;var n=t("../utils/Utils");function r(t,e,o){o=n.defaults(o,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.id=r.idCounter++,this.collideConnected=o.collideConnected,o.wakeUpBodies&&(t&&t.wakeUp(),e&&e.wakeUp())}r.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},r.prototype.enable=function(){for(var t=this.equations,i=0;i<t.length;i++)t[i].enabled=!0},r.prototype.disable=function(){for(var t=this.equations,i=0;i<t.length;i++)t[i].enabled=!1},r.idCounter=0},{"../utils/Utils":53}],14:[function(t,e,o){e.exports=l;var n=t("./Constraint"),r=t("../equations/ContactEquation");function l(t,e,o,l){n.call(this,t,e),void 0===o&&(o=t.position.distanceTo(e.position)),void 0===l&&(l=1e6),this.distance=o;var h=this.distanceEquation=new r(t,e);this.equations.push(h),h.minForce=-l,h.maxForce=l}l.prototype=new n,l.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.distanceEquation,n=.5*this.distance,r=o.ni;e.position.vsub(t.position,r),r.normalize(),r.mult(n,o.ri),r.mult(-n,o.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(t,e,o){e.exports=c,t("./Constraint");var n=t("./PointToPointConstraint"),r=t("../equations/RotationalEquation"),l=t("../equations/RotationalMotorEquation"),h=(t("../equations/ContactEquation"),t("../math/Vec3"));function c(t,e,o){var c=void 0!==(o=o||{}).maxForce?o.maxForce:1e6,d=o.pivotA?o.pivotA.clone():new h,v=o.pivotB?o.pivotB.clone():new h;n.call(this,t,d,e,v,c),(this.axisA=o.axisA?o.axisA.clone():new h(1,0,0)).normalize(),(this.axisB=o.axisB?o.axisB.clone():new h(1,0,0)).normalize();var y=this.rotationalEquation1=new r(t,e,o),f=this.rotationalEquation2=new r(t,e,o),m=this.motorEquation=new l(t,e,c);m.enabled=!1,this.equations.push(y,f,m)}c.prototype=new n,c.constructor=c,c.prototype.enableMotor=function(){this.motorEquation.enabled=!0},c.prototype.disableMotor=function(){this.motorEquation.enabled=!1},c.prototype.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t},c.prototype.setMotorMaxForce=function(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t};var d=new h,v=new h;c.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.motorEquation,r=this.rotationalEquation1,l=this.rotationalEquation2,h=d,c=v,y=this.axisA,f=this.axisB;n.prototype.update.call(this),t.quaternion.vmult(y,h),e.quaternion.vmult(f,c),h.tangents(r.axisA,l.axisA),r.axisB.copy(c),l.axisB.copy(c),this.motorEquation.enabled&&(t.quaternion.vmult(this.axisA,o.axisA),e.quaternion.vmult(this.axisB,o.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(t,e,o){e.exports=h,t("./Constraint");var n=t("./PointToPointConstraint"),r=t("../equations/RotationalEquation"),l=(t("../equations/RotationalMotorEquation"),t("../equations/ContactEquation"),t("../math/Vec3"));function h(t,e,o){var h=void 0!==(o=o||{}).maxForce?o.maxForce:1e6,c=new l,d=new l,v=new l;t.position.vadd(e.position,v),v.scale(.5,v),e.pointToLocalFrame(v,d),t.pointToLocalFrame(v,c),n.call(this,t,c,e,d,h);var y=this.rotationalEquation1=new r(t,e,o),f=this.rotationalEquation2=new r(t,e,o),m=this.rotationalEquation3=new r(t,e,o);this.equations.push(y,f,m)}h.prototype=new n,h.constructor=h,new l,new l,h.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,h=this.rotationalEquation3;n.prototype.update.call(this),t.vectorToWorldFrame(l.UNIT_X,o.axisA),e.vectorToWorldFrame(l.UNIT_Y,o.axisB),t.vectorToWorldFrame(l.UNIT_Y,r.axisA),e.vectorToWorldFrame(l.UNIT_Z,r.axisB),t.vectorToWorldFrame(l.UNIT_Z,h.axisA),e.vectorToWorldFrame(l.UNIT_X,h.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(t,e,o){e.exports=h;var n=t("./Constraint"),r=t("../equations/ContactEquation"),l=t("../math/Vec3");function h(t,e,o,h,c){n.call(this,t,o),c=void 0!==c?c:1e6,this.pivotA=e?e.clone():new l,this.pivotB=h?h.clone():new l;var d=this.equationX=new r(t,o),v=this.equationY=new r(t,o),y=this.equationZ=new r(t,o);this.equations.push(d,v,y),d.minForce=v.minForce=y.minForce=-c,d.maxForce=v.maxForce=y.maxForce=c,d.ni.set(1,0,0),v.ni.set(0,1,0),y.ni.set(0,0,1)}h.prototype=new n,h.prototype.update=function(){var t=this.bodyA,e=this.bodyB,o=this.equationX,n=this.equationY,r=this.equationZ;t.quaternion.vmult(this.pivotA,o.ri),e.quaternion.vmult(this.pivotB,o.rj),n.ri.copy(o.ri),n.rj.copy(o.rj),r.ri.copy(o.ri),r.rj.copy(o.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(t,e,o){e.exports=l;var n=t("../math/Vec3"),r=(t("../math/Mat3"),t("./Equation"));function l(t,e,o){var l=void 0!==(o=o||{}).maxForce?o.maxForce:1e6;r.call(this,t,e,-l,l),this.axisA=o.axisA?o.axisA.clone():new n(1,0,0),this.axisB=o.axisB?o.axisB.clone():new n(0,1,0),this.angle=void 0!==o.angle?o.angle:0}l.prototype=new r,l.prototype.constructor=l;var h=new n,c=new n;l.prototype.computeB=function(t){var a=this.a,b=this.b,e=this.axisA,o=this.axisB,n=h,r=c,l=this.jacobianElementA,d=this.jacobianElementB;return e.cross(o,n),o.cross(e,r),l.rotational.copy(r),d.rotational.copy(n),-(Math.cos(this.angle)-e.dot(o))*a-this.computeGW()*b-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(t,e,o){e.exports=l;var n=t("./Equation"),r=t("../math/Vec3");function l(t,e,o){o=void 0!==o?o:1e6,n.call(this,t,e,0,o),this.restitution=0,this.ri=new r,this.rj=new r,this.ni=new r}t("../math/Mat3"),l.prototype=new n,l.prototype.constructor=l;var h=new r,c=new r,d=new r;l.prototype.computeB=function(t){var a=this.a,b=this.b,e=this.bi,o=this.bj,n=this.ri,r=this.rj,l=h,v=c,y=e.velocity,f=e.angularVelocity,m=(e.force,e.torque,o.velocity),w=o.angularVelocity,x=(o.force,o.torque,d),B=this.jacobianElementA,E=this.jacobianElementB,A=this.ni;n.cross(A,l),r.cross(A,v),A.negate(B.spatial),l.negate(B.rotational),E.spatial.copy(A),E.rotational.copy(v),x.copy(o.position),x.vadd(r,x),x.vsub(e.position,x),x.vsub(n,x);var g=A.dot(x),S=this.restitution+1;return-g*a-(S*m.dot(A)-S*y.dot(A)+w.dot(v)-f.dot(l))*b-t*this.computeGiMf()};var v=new r,y=new r,f=new r,m=new r,w=new r;l.prototype.getImpactVelocityAlongNormal=function(){var t=v,e=y,o=f,n=m,r=w;return this.bi.position.vadd(this.ri,o),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(o,t),this.bj.getVelocityAtWorldPoint(n,e),t.vsub(e,r),this.ni.dot(r)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(t,e,o){e.exports=l;var n=t("../math/JacobianElement"),r=t("../math/Vec3");function l(t,e,o,r){this.id=l.id++,this.minForce=void 0===o?-1e6:o,this.maxForce=void 0===r?1e6:r,this.bi=t,this.bj=e,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}l.prototype.constructor=l,l.id=0,l.prototype.setSpookParams=function(t,e,o){var n=e,r=t,l=o;this.a=4/(l*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(l*l*r*(1+4*n))},l.prototype.computeB=function(a,b,t){var e=this.computeGW();return-this.computeGq()*a-e*b-this.computeGiMf()*t},l.prototype.computeGq=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,n=this.bj,r=o.position,l=n.position;return t.spatial.dot(r)+e.spatial.dot(l)};var h=new r;l.prototype.computeGW=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,n=this.bj,r=o.velocity,l=n.velocity,c=o.angularVelocity||h,d=n.angularVelocity||h;return t.multiplyVectors(r,c)+e.multiplyVectors(l,d)},l.prototype.computeGWlambda=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,n=this.bj,r=o.vlambda,l=n.vlambda,c=o.wlambda||h,d=n.wlambda||h;return t.multiplyVectors(r,c)+e.multiplyVectors(l,d)};var c=new r,d=new r,v=new r,y=new r;l.prototype.computeGiMf=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,n=this.bj,r=o.force,l=o.torque,h=n.force,f=n.torque,m=o.invMassSolve,w=n.invMassSolve;return o.invInertiaWorldSolve?o.invInertiaWorldSolve.vmult(l,v):v.set(0,0,0),n.invInertiaWorldSolve?n.invInertiaWorldSolve.vmult(f,y):y.set(0,0,0),r.mult(m,c),h.mult(w,d),t.multiplyVectors(c,v)+e.multiplyVectors(d,y)};var f=new r;l.prototype.computeGiMGt=function(){var t=this.jacobianElementA,e=this.jacobianElementB,o=this.bi,n=this.bj,r=o.invMassSolve,l=n.invMassSolve,h=o.invInertiaWorldSolve,c=n.invInertiaWorldSolve,d=r+l;return h&&(h.vmult(t.rotational,f),d+=f.dot(t.rotational)),c&&(c.vmult(e.rotational,f),d+=f.dot(e.rotational)),d};var m=new r;new r,new r,new r,new r,new r,l.prototype.addToWlambda=function(t){var e=this.jacobianElementA,o=this.jacobianElementB,n=this.bi,r=this.bj,l=m;e.spatial.mult(n.invMassSolve*t,l),n.vlambda.vadd(l,n.vlambda),o.spatial.mult(r.invMassSolve*t,l),r.vlambda.vadd(l,r.vlambda),n.invInertiaWorldSolve&&(n.invInertiaWorldSolve.vmult(e.rotational,l),l.mult(t,l),n.wlambda.vadd(l,n.wlambda)),r.invInertiaWorldSolve&&(r.invInertiaWorldSolve.vmult(o.rotational,l),l.mult(t,l),r.wlambda.vadd(l,r.wlambda))},l.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(t,e,o){e.exports=l;var n=t("./Equation"),r=t("../math/Vec3");function l(t,e,o){n.call(this,t,e,-o,o),this.ri=new r,this.rj=new r,this.t=new r}t("../math/Mat3"),l.prototype=new n,l.prototype.constructor=l;var h=new r,c=new r;l.prototype.computeB=function(t){this.a;var b=this.b,e=(this.bi,this.bj,this.ri),o=this.rj,n=h,r=c,l=this.t;e.cross(l,n),o.cross(l,r);var d=this.jacobianElementA,v=this.jacobianElementB;return l.negate(d.spatial),n.negate(d.rotational),v.spatial.copy(l),v.rotational.copy(r),-this.computeGW()*b-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(t,e,o){e.exports=l;var n=t("../math/Vec3"),r=(t("../math/Mat3"),t("./Equation"));function l(t,e,o){var l=void 0!==(o=o||{}).maxForce?o.maxForce:1e6;r.call(this,t,e,-l,l),this.axisA=o.axisA?o.axisA.clone():new n(1,0,0),this.axisB=o.axisB?o.axisB.clone():new n(0,1,0),this.maxAngle=Math.PI/2}l.prototype=new r,l.prototype.constructor=l;var h=new n,c=new n;l.prototype.computeB=function(t){var a=this.a,b=this.b,e=this.axisA,o=this.axisB,n=h,r=c,l=this.jacobianElementA,d=this.jacobianElementB;return e.cross(o,n),o.cross(e,r),l.rotational.copy(r),d.rotational.copy(n),-(Math.cos(this.maxAngle)-e.dot(o))*a-this.computeGW()*b-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(t,e,o){e.exports=l;var n=t("../math/Vec3"),r=(t("../math/Mat3"),t("./Equation"));function l(t,e,o){o=void 0!==o?o:1e6,r.call(this,t,e,-o,o),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}l.prototype=new r,l.prototype.constructor=l,l.prototype.computeB=function(t){this.a;var b=this.b,e=(this.bi,this.bj,this.axisA),o=this.axisB,n=this.jacobianElementA,r=this.jacobianElementB;return n.rotational.copy(e),o.negate(r.rotational),-(this.computeGW()-this.targetVelocity)*b-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(t,e,o){var n=t("../utils/Utils");function r(t,e,o){o=n.defaults(o,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=r.idCounter++,this.materials=[t,e],this.friction=o.friction,this.restitution=o.restitution,this.contactEquationStiffness=o.contactEquationStiffness,this.contactEquationRelaxation=o.contactEquationRelaxation,this.frictionEquationStiffness=o.frictionEquationStiffness,this.frictionEquationRelaxation=o.frictionEquationRelaxation}e.exports=r,r.idCounter=0},{"../utils/Utils":53}],25:[function(t,e,o){function n(t){var e="";"string"==typeof(t=t||{})?(e=t,t={}):"object"==typeof t&&(e=""),this.name=e,this.id=n.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}e.exports=n,n.idCounter=0},{}],26:[function(t,e,o){e.exports=r;var n=t("./Vec3");function r(){this.spatial=new n,this.rotational=new n}r.prototype.multiplyElement=function(element){return element.spatial.dot(this.spatial)+element.rotational.dot(this.rotational)},r.prototype.multiplyVectors=function(t,e){return t.dot(this.spatial)+e.dot(this.rotational)}},{"./Vec3":30}],27:[function(t,e,o){e.exports=r;var n=t("./Vec3");function r(t){this.elements=t||[0,0,0,0,0,0,0,0,0]}r.prototype.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},r.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},r.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},r.prototype.getTrace=function(t){t=t||new n;var e=this.elements;t.x=e[0],t.y=e[4],t.z=e[8]},r.prototype.vmult=function(t,e){e=e||new n;var o=this.elements,r=t.x,l=t.y,h=t.z;return e.x=o[0]*r+o[1]*l+o[2]*h,e.y=o[3]*r+o[4]*l+o[5]*h,e.z=o[6]*r+o[7]*l+o[8]*h,e},r.prototype.smult=function(s){for(var i=0;i<this.elements.length;i++)this.elements[i]*=s},r.prototype.mmult=function(t,e){for(var o=e||new r,i=0;i<3;i++)for(var n=0;n<3;n++){for(var l=0,h=0;h<3;h++)l+=t.elements[i+3*h]*this.elements[h+3*n];o.elements[i+3*n]=l}return o},r.prototype.scale=function(t,e){e=e||new r;for(var o=this.elements,n=e.elements,i=0;3!==i;i++)n[3*i+0]=t.x*o[3*i+0],n[3*i+1]=t.y*o[3*i+1],n[3*i+2]=t.z*o[3*i+2];return e},r.prototype.solve=function(b,t){t=t||new n;for(var e,o=3,r=4,l=[],i=0;i<o*r;i++)l.push(0);for(i=0;i<3;i++)for(e=0;e<3;e++)l[i+r*e]=this.elements[i+3*e];l[3]=b.x,l[7]=b.y,l[11]=b.z;var h,p,c=3,d=c,v=4;do{if(0===l[(i=d-c)+r*i])for(e=i+1;e<d;e++)if(0!==l[i+r*e]){h=v;do{l[(p=v-h)+r*i]+=l[p+r*e]}while(--h);break}if(0!==l[i+r*i])for(e=i+1;e<d;e++){var y=l[i+r*e]/l[i+r*i];h=v;do{l[(p=v-h)+r*e]=p<=i?0:l[p+r*e]-l[p+r*i]*y}while(--h)}}while(--c);if(t.z=l[2*r+3]/l[2*r+2],t.y=(l[1*r+3]-l[1*r+2]*t.z)/l[1*r+1],t.x=(l[0*r+3]-l[0*r+2]*t.z-l[0*r+1]*t.y)/l[0*r+0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+b.toString()+"], A=["+this.toString()+"]";return t},r.prototype.e=function(t,e,o){if(void 0===o)return this.elements[e+3*t];this.elements[e+3*t]=o},r.prototype.copy=function(source){for(var i=0;i<source.elements.length;i++)this.elements[i]=source.elements[i];return this},r.prototype.toString=function(){for(var t="",e=",",i=0;i<9;i++)t+=this.elements[i]+e;return t},r.prototype.reverse=function(t){t=t||new r;for(var e,o=3,n=6,l=[],i=0;i<o*n;i++)l.push(0);for(i=0;i<3;i++)for(e=0;e<3;e++)l[i+n*e]=this.elements[i+3*e];l[3]=1,l[9]=0,l[15]=0,l[4]=0,l[10]=1,l[16]=0,l[5]=0,l[11]=0,l[17]=1;var h,p,c=3,d=c,v=n;do{if(0===l[(i=d-c)+n*i])for(e=i+1;e<d;e++)if(0!==l[i+n*e]){h=v;do{l[(p=v-h)+n*i]+=l[p+n*e]}while(--h);break}if(0!==l[i+n*i])for(e=i+1;e<d;e++){var y=l[i+n*e]/l[i+n*i];h=v;do{l[(p=v-h)+n*e]=p<=i?0:l[p+n*e]-l[p+n*i]*y}while(--h)}}while(--c);i=2;do{e=i-1;do{y=l[i+n*e]/l[i+n*i],h=n;do{l[(p=n-h)+n*e]=l[p+n*e]-l[p+n*i]*y}while(--h)}while(e--)}while(--i);i=2;do{y=1/l[i+n*i],h=n;do{l[(p=n-h)+n*i]=l[p+n*i]*y}while(--h)}while(i--);i=2;do{e=2;do{if(p=l[o+e+n*i],isNaN(p)||p===1/0)throw"Could not reverse! A=["+this.toString()+"]";t.e(i,e,p)}while(e--)}while(i--);return t},r.prototype.setRotationFromQuaternion=function(q){var t=q.x,e=q.y,o=q.z,n=q.w,r=t+t,l=e+e,h=o+o,c=t*r,d=t*l,v=t*h,y=e*l,f=e*h,m=o*h,w=n*r,x=n*l,B=n*h,E=this.elements;return E[0]=1-(y+m),E[1]=d-B,E[2]=v+x,E[3]=d+B,E[4]=1-(c+m),E[5]=f-w,E[6]=v-x,E[7]=f+w,E[8]=1-(c+y),this},r.prototype.transpose=function(t){for(var e=(t=t||new r).elements,o=this.elements,i=0;3!==i;i++)for(var n=0;3!==n;n++)e[3*i+n]=o[3*n+i];return t}},{"./Vec3":30}],28:[function(t,e,o){e.exports=r;var n=t("./Vec3");function r(t,e,o,n){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==o?o:0,this.w=void 0!==n?n:1}r.prototype.set=function(t,e,o,n){this.x=t,this.y=e,this.z=o,this.w=n},r.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},r.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},r.prototype.setFromAxisAngle=function(t,e){var s=Math.sin(.5*e);this.x=t.x*s,this.y=t.y*s,this.z=t.z*s,this.w=Math.cos(.5*e)},r.prototype.toAxisAngle=function(t){t=t||new n,this.normalize();var e=2*Math.acos(this.w),s=Math.sqrt(1-this.w*this.w);return s<.001?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/s,t.y=this.y/s,t.z=this.z/s),[t,e]};var l=new n,h=new n;r.prototype.setFromVectors=function(u,t){if(u.isAntiparallelTo(t)){var e=l,o=h;u.tangents(e,o),this.setFromAxisAngle(e,Math.PI)}else{var a=u.cross(t);this.x=a.x,this.y=a.y,this.z=a.z,this.w=Math.sqrt(Math.pow(u.norm(),2)*Math.pow(t.norm(),2))+u.dot(t),this.normalize()}};var c=new n,d=new n,v=new n;r.prototype.mult=function(q,t){t=t||new r;var e=this.w,o=c,n=d,l=v;return o.set(this.x,this.y,this.z),n.set(q.x,q.y,q.z),t.w=e*q.w-o.dot(n),o.cross(n,l),t.x=e*n.x+q.w*o.x+l.x,t.y=e*n.y+q.w*o.y+l.y,t.z=e*n.z+q.w*o.z+l.z,t},r.prototype.inverse=function(t){var e=this.x,o=this.y,n=this.z,l=this.w;t=t||new r,this.conjugate(t);var h=1/(e*e+o*o+n*n+l*l);return t.x*=h,t.y*=h,t.z*=h,t.w*=h,t},r.prototype.conjugate=function(t){return(t=t||new r).x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t},r.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},r.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},r.prototype.vmult=function(t,e){e=e||new n;var o=t.x,r=t.y,l=t.z,h=this.x,c=this.y,d=this.z,v=this.w,y=v*o+c*l-d*r,f=v*r+d*o-h*l,m=v*l+h*r-c*o,w=-h*o-c*r-d*l;return e.x=y*v+w*-h+f*-d-m*-c,e.y=f*v+w*-c+m*-h-y*-d,e.z=m*v+w*-d+y*-c-f*-h,e},r.prototype.copy=function(source){return this.x=source.x,this.y=source.y,this.z=source.z,this.w=source.w,this},r.prototype.toEuler=function(t,e){var o,n,r;e=e||"YZX";var l=this.x,h=this.y,c=this.z,d=this.w;if("YZX"!==e)throw new Error("Euler order "+e+" not supported yet.");var v=l*h+c*d;if(v>.499&&(o=2*Math.atan2(l,d),n=Math.PI/2,r=0),v<-.499&&(o=-2*Math.atan2(l,d),n=-Math.PI/2,r=0),isNaN(o)){var y=l*l,f=h*h,m=c*c;o=Math.atan2(2*h*d-2*l*c,1-2*f-2*m),n=Math.asin(2*v),r=Math.atan2(2*l*d-2*h*c,1-2*y-2*m)}t.y=o,t.z=n,t.x=r},r.prototype.setFromEuler=function(t,e,o,n){n=n||"XYZ";var r=Math.cos(t/2),l=Math.cos(e/2),h=Math.cos(o/2),c=Math.sin(t/2),d=Math.sin(e/2),v=Math.sin(o/2);return"XYZ"===n?(this.x=c*l*h+r*d*v,this.y=r*d*h-c*l*v,this.z=r*l*v+c*d*h,this.w=r*l*h-c*d*v):"YXZ"===n?(this.x=c*l*h+r*d*v,this.y=r*d*h-c*l*v,this.z=r*l*v-c*d*h,this.w=r*l*h+c*d*v):"ZXY"===n?(this.x=c*l*h-r*d*v,this.y=r*d*h+c*l*v,this.z=r*l*v+c*d*h,this.w=r*l*h-c*d*v):"ZYX"===n?(this.x=c*l*h-r*d*v,this.y=r*d*h+c*l*v,this.z=r*l*v-c*d*h,this.w=r*l*h+c*d*v):"YZX"===n?(this.x=c*l*h+r*d*v,this.y=r*d*h+c*l*v,this.z=r*l*v-c*d*h,this.w=r*l*h-c*d*v):"XZY"===n&&(this.x=c*l*h-r*d*v,this.y=r*d*h-c*l*v,this.z=r*l*v+c*d*h,this.w=r*l*h+c*d*v),this},r.prototype.clone=function(){return new r(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(t,e,o){var n=t("./Vec3"),r=t("./Quaternion");function l(t){t=t||{},this.position=new n,t.position&&this.position.copy(t.position),this.quaternion=new r,t.quaternion&&this.quaternion.copy(t.quaternion)}e.exports=l;var h=new r;l.pointToLocalFrame=function(t,e,o,r){return r=r||new n,o.vsub(t,r),e.conjugate(h),h.vmult(r,r),r},l.prototype.pointToLocal=function(t,e){return l.pointToLocalFrame(this.position,this.quaternion,t,e)},l.pointToWorldFrame=function(t,e,o,r){return r=r||new n,e.vmult(o,r),r.vadd(t,r),r},l.prototype.pointToWorld=function(t,e){return l.pointToWorldFrame(this.position,this.quaternion,t,e)},l.prototype.vectorToWorldFrame=function(t,e){return e=e||new n,this.quaternion.vmult(t,e),e},l.vectorToWorldFrame=function(t,e,o){return t.vmult(e,o),o},l.vectorToLocalFrame=function(t,e,o,r){return r=r||new n,e.w*=-1,e.vmult(o,r),e.w*=-1,r}},{"./Quaternion":28,"./Vec3":30}],30:[function(t,e,o){e.exports=r;var n=t("./Mat3");function r(t,e,o){this.x=t||0,this.y=e||0,this.z=o||0}r.ZERO=new r(0,0,0),r.UNIT_X=new r(1,0,0),r.UNIT_Y=new r(0,1,0),r.UNIT_Z=new r(0,0,1),r.prototype.cross=function(t,e){var o=t.x,n=t.y,l=t.z,h=this.x,c=this.y,d=this.z;return(e=e||new r).x=c*l-d*n,e.y=d*o-h*l,e.z=h*n-c*o,e},r.prototype.set=function(t,e,o){return this.x=t,this.y=e,this.z=o,this},r.prototype.setZero=function(){this.x=this.y=this.z=0},r.prototype.vadd=function(t,e){if(!e)return new r(this.x+t.x,this.y+t.y,this.z+t.z);e.x=t.x+this.x,e.y=t.y+this.y,e.z=t.z+this.z},r.prototype.vsub=function(t,e){if(!e)return new r(this.x-t.x,this.y-t.y,this.z-t.z);e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z},r.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},r.prototype.normalize=function(){var t=this.x,e=this.y,o=this.z,n=Math.sqrt(t*t+e*e+o*o);if(n>0){var r=1/n;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return n},r.prototype.unit=function(t){t=t||new r;var e=this.x,o=this.y,n=this.z,l=Math.sqrt(e*e+o*o+n*n);return l>0?(l=1/l,t.x=e*l,t.y=o*l,t.z=n*l):(t.x=1,t.y=0,t.z=0),t},r.prototype.norm=function(){var t=this.x,e=this.y,o=this.z;return Math.sqrt(t*t+e*e+o*o)},r.prototype.length=r.prototype.norm,r.prototype.norm2=function(){return this.dot(this)},r.prototype.lengthSquared=r.prototype.norm2,r.prototype.distanceTo=function(p){var t=this.x,e=this.y,o=this.z,n=p.x,r=p.y,l=p.z;return Math.sqrt((n-t)*(n-t)+(r-e)*(r-e)+(l-o)*(l-o))},r.prototype.distanceSquared=function(p){var t=this.x,e=this.y,o=this.z,n=p.x,r=p.y,l=p.z;return(n-t)*(n-t)+(r-e)*(r-e)+(l-o)*(l-o)},r.prototype.mult=function(t,e){e=e||new r;var o=this.x,n=this.y,l=this.z;return e.x=t*o,e.y=t*n,e.z=t*l,e},r.prototype.scale=r.prototype.mult,r.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},r.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},r.prototype.negate=function(t){return(t=t||new r).x=-this.x,t.y=-this.y,t.z=-this.z,t};var l=new r,h=new r;r.prototype.tangents=function(t,e){var o=this.norm();if(o>0){var n=l,r=1/o;n.set(this.x*r,this.y*r,this.z*r);var c=h;Math.abs(n.x)<.9?(c.set(1,0,0),n.cross(c,t)):(c.set(0,1,0),n.cross(c,t)),n.cross(t,e)}else t.set(1,0,0),e.set(0,1,0)},r.prototype.toString=function(){return this.x+","+this.y+","+this.z},r.prototype.toArray=function(){return[this.x,this.y,this.z]},r.prototype.copy=function(source){return this.x=source.x,this.y=source.y,this.z=source.z,this},r.prototype.lerp=function(t,e,o){var n=this.x,r=this.y,l=this.z;o.x=n+(t.x-n)*e,o.y=r+(t.y-r)*e,o.z=l+(t.z-l)*e},r.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)},r.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)};var c=new r;r.prototype.isAntiparallelTo=function(t,e){return this.negate(c),c.almostEquals(t,e)},r.prototype.clone=function(){return new r(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(t,e,o){e.exports=v;var n=t("../utils/EventTarget"),r=(t("../shapes/Shape"),t("../math/Vec3")),l=t("../math/Mat3"),h=t("../math/Quaternion"),c=(t("../material/Material"),t("../collision/AABB")),d=t("../shapes/Box");function v(t){t=t||{},n.apply(this),this.id=v.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new r,this.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:1,this.collisionResponse=!0,this.position=new r,t.position&&this.position.copy(t.position),this.previousPosition=new r,this.initPosition=new r,this.velocity=new r,t.velocity&&this.velocity.copy(t.velocity),this.initVelocity=new r,this.force=new r;var e="number"==typeof t.mass?t.mass:0;this.mass=e,this.invMass=e>0?1/e:0,this.material=t.material||null,this.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01,this.type=e<=0?v.STATIC:v.DYNAMIC,typeof t.type==typeof v.STATIC&&(this.type=t.type),this.allowSleep=void 0===t.allowSleep||t.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==t.sleepSpeedLimit?t.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==t.sleepTimeLimit?t.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new r,this.quaternion=new h,t.quaternion&&this.quaternion.copy(t.quaternion),this.initQuaternion=new h,this.angularVelocity=new r,t.angularVelocity&&this.angularVelocity.copy(t.angularVelocity),this.initAngularVelocity=new r,this.interpolatedPosition=new r,this.interpolatedQuaternion=new h,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new r,this.invInertia=new r,this.invInertiaWorld=new l,this.invMassSolve=0,this.invInertiaSolve=new r,this.invInertiaWorldSolve=new l,this.fixedRotation=void 0!==t.fixedRotation&&t.fixedRotation,this.angularDamping=void 0!==t.angularDamping?t.angularDamping:.01,this.aabb=new c,this.aabbNeedsUpdate=!0,this.wlambda=new r,t.shape&&this.addShape(t.shape),this.updateMassProperties()}v.prototype=new n,v.prototype.constructor=v,v.DYNAMIC=1,v.STATIC=2,v.KINEMATIC=4,v.AWAKE=0,v.SLEEPY=1,v.SLEEPING=2,v.idCounter=0,v.prototype.wakeUp=function(){var s=this.sleepState;this.sleepState=0,s===v.SLEEPING&&this.dispatchEvent({type:"wakeup"})},v.prototype.sleep=function(){this.sleepState=v.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},v.sleepyEvent={type:"sleepy"},v.sleepEvent={type:"sleep"},v.prototype.sleepTick=function(time){if(this.allowSleep){var t=this.sleepState,e=this.velocity.norm2()+this.angularVelocity.norm2(),o=Math.pow(this.sleepSpeedLimit,2);t===v.AWAKE&&e<o?(this.sleepState=v.SLEEPY,this.timeLastSleepy=time,this.dispatchEvent(v.sleepyEvent)):t===v.SLEEPY&&e>o?this.wakeUp():t===v.SLEEPY&&time-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(v.sleepEvent))}},v.prototype.updateSolveMassProperties=function(){this.sleepState===v.SLEEPING||this.type===v.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},v.prototype.pointToLocalFrame=function(t,e){return e=e||new r,t.vsub(this.position,e),this.quaternion.conjugate().vmult(e,e),e},v.prototype.vectorToLocalFrame=function(t,e){return e=e||new r,this.quaternion.conjugate().vmult(t,e),e},v.prototype.pointToWorldFrame=function(t,e){return e=e||new r,this.quaternion.vmult(t,e),e.vadd(this.position,e),e},v.prototype.vectorToWorldFrame=function(t,e){return e=e||new r,this.quaternion.vmult(t,e),e};var y=new r,f=new h;v.prototype.addShape=function(t,e,o){var n=new r,l=new h;return e&&n.copy(e),o&&l.copy(o),this.shapes.push(t),this.shapeOffsets.push(n),this.shapeOrientations.push(l),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},v.prototype.updateBoundingRadius=function(){for(var t=this.shapes,e=this.shapeOffsets,o=t.length,n=0,i=0;i!==o;i++){var r=t[i];r.updateBoundingSphereRadius();var l=e[i].norm(),h=r.boundingSphereRadius;l+h>n&&(n=l+h)}this.boundingRadius=n};var m=new c;v.prototype.computeAABB=function(){for(var t=this.shapes,e=this.shapeOffsets,o=this.shapeOrientations,n=t.length,r=y,l=f,h=this.quaternion,c=this.aabb,d=m,i=0;i!==n;i++){var v=t[i];o[i].mult(h,l),l.vmult(e[i],r),r.vadd(this.position,r),v.calculateWorldAABB(r,l,d.lowerBound,d.upperBound),0===i?c.copy(d):c.extend(d)}this.aabbNeedsUpdate=!1};var w=new l,x=new l;new l,v.prototype.updateInertiaWorld=function(t){var e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){var o=w,n=x;o.setRotationFromQuaternion(this.quaternion),o.transpose(n),o.scale(e,o),o.mmult(n,this.invInertiaWorld)}};var B=new r,E=new r;v.prototype.applyForce=function(t,e){if(this.type===v.DYNAMIC){var o=B;e.vsub(this.position,o);var n=E;o.cross(t,n),this.force.vadd(t,this.force),this.torque.vadd(n,this.torque)}};var A=new r,S=new r;v.prototype.applyLocalForce=function(t,e){if(this.type===v.DYNAMIC){var o=A,n=S;this.vectorToWorldFrame(t,o),this.pointToWorldFrame(e,n),this.applyForce(o,n)}};var C=new r,z=new r,R=new r;v.prototype.applyImpulse=function(t,e){if(this.type===v.DYNAMIC){var o=C;e.vsub(this.position,o);var n=z;n.copy(t),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var r=R;o.cross(t,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var M=new r,P=new r;v.prototype.applyLocalImpulse=function(t,e){if(this.type===v.DYNAMIC){var o=M,n=P;this.vectorToWorldFrame(t,o),this.pointToWorldFrame(e,n),this.applyImpulse(o,n)}};var F=new r;v.prototype.updateMassProperties=function(){var t=F;this.invMass=this.mass>0?1/this.mass:0;var e=this.inertia,o=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),d.calculateInertia(t,this.mass,e),this.invInertia.set(e.x>0&&!o?1/e.x:0,e.y>0&&!o?1/e.y:0,e.z>0&&!o?1/e.z:0),this.updateInertiaWorld(!0)},v.prototype.getVelocityAtWorldPoint=function(t,e){var o=new r;return t.vsub(this.position,o),this.angularVelocity.cross(o,e),this.velocity.vadd(e,e),e}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(t,e,o){t("./Body");var n=t("../math/Vec3"),r=t("../math/Quaternion"),l=(t("../collision/RaycastResult"),t("../collision/Ray")),h=t("../objects/WheelInfo");function c(t){this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:1,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:0,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:2}e.exports=c,new n,new n,new n;var d=new n,v=new n,y=new n;new l,c.prototype.addWheel=function(t){var e=new h(t=t||{}),o=this.wheelInfos.length;return this.wheelInfos.push(e),o},c.prototype.setSteeringValue=function(t,e){this.wheelInfos[e].steering=t},new n,c.prototype.applyEngineForce=function(t,e){this.wheelInfos[e].engineForce=t},c.prototype.setBrake=function(t,e){this.wheelInfos[e].brake=t},c.prototype.addToWorld=function(t){this.constraints,t.add(this.chassisBody);var e=this;this.preStepCallback=function(){e.updateVehicle(t.dt)},t.addEventListener("preStep",this.preStepCallback),this.world=t},c.prototype.getVehicleAxisWorld=function(t,e){e.set(0===t?1:0,1===t?1:0,2===t?1:0),this.chassisBody.vectorToWorldFrame(e,e)},c.prototype.updateVehicle=function(t){for(var e=this.wheelInfos,o=e.length,r=this.chassisBody,i=0;i<o;i++)this.updateWheelTransform(i);this.currentVehicleSpeedKmHour=3.6*r.velocity.norm();var l=new n;for(this.getVehicleAxisWorld(this.indexForwardAxis,l),l.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),i=0;i<o;i++)this.castRay(e[i]);this.updateSuspension(t);var h=new n,c=new n;for(i=0;i<o;i++){var d=(m=e[i]).suspensionForce;d>m.maxSuspensionForce&&(d=m.maxSuspensionForce),m.raycastResult.hitNormalWorld.scale(d*t,h),m.raycastResult.hitPointWorld.vsub(r.position,c),r.applyImpulse(h,m.raycastResult.hitPointWorld)}this.updateFriction(t);var v=new n,y=new n,f=new n;for(i=0;i<o;i++){var m=e[i];r.getVelocityAtWorldPoint(m.chassisConnectionPointWorld,f);var w=1;if(1===this.indexUpAxis&&(w=-1),m.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,y);var x=y.dot(m.raycastResult.hitNormalWorld);m.raycastResult.hitNormalWorld.scale(x,v),y.vsub(v,y);var B=y.dot(f);m.deltaRotation=w*B*t/m.radius}!m.sliding&&m.isInContact||0===m.engineForce||!m.useCustomSlidingRotationalSpeed||(m.deltaRotation=(m.engineForce>0?1:-1)*m.customSlidingRotationalSpeed*t),Math.abs(m.brake)>Math.abs(m.engineForce)&&(m.deltaRotation=0),m.rotation+=m.deltaRotation,m.deltaRotation*=.99}},c.prototype.updateSuspension=function(t){for(var e=this.chassisBody.mass,o=this.wheelInfos,n=o.length,r=0;r<n;r++){var l=o[r];if(l.isInContact){var h,c=l.suspensionRestLength-l.suspensionLength;h=l.suspensionStiffness*c*l.clippedInvContactDotSuspension;var d=l.suspensionRelativeVelocity;h-=(d<0?l.dampingCompression:l.dampingRelaxation)*d,l.suspensionForce=h*e,l.suspensionForce<0&&(l.suspensionForce=0)}else l.suspensionForce=0}},c.prototype.removeFromWorld=function(t){this.constraints,t.remove(this.chassisBody),t.removeEventListener("preStep",this.preStepCallback),this.world=null};var f=new n,m=new n;c.prototype.castRay=function(t){var e=f,o=m;this.updateWheelTransformWorld(t);var r=this.chassisBody,l=-1,h=t.suspensionRestLength+t.radius;t.directionWorld.scale(h,e);var source=t.chassisConnectionPointWorld;source.vadd(e,o);var c=t.raycastResult;c.reset();var d=r.collisionResponse;r.collisionResponse=!1,this.world.rayTest(source,o,c),r.collisionResponse=d;var object=c.body;if(t.raycastResult.groundObject=0,object){l=c.distance,t.raycastResult.hitNormalWorld=c.hitNormalWorld,t.isInContact=!0;var v=c.distance;t.suspensionLength=v-t.radius;var y=t.suspensionRestLength-t.maxSuspensionTravel,w=t.suspensionRestLength+t.maxSuspensionTravel;t.suspensionLength<y&&(t.suspensionLength=y),t.suspensionLength>w&&(t.suspensionLength=w,t.raycastResult.reset());var x=t.raycastResult.hitNormalWorld.dot(t.directionWorld),B=new n;r.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,B);var E=t.raycastResult.hitNormalWorld.dot(B);if(x>=-.1)t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10;else{var A=-1/x;t.suspensionRelativeVelocity=E*A,t.clippedInvContactDotSuspension=A}}else t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1;return l},c.prototype.updateWheelTransformWorld=function(t){t.isInContact=!1;var e=this.chassisBody;e.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld),e.vectorToWorldFrame(t.directionLocal,t.directionWorld),e.vectorToWorldFrame(t.axleLocal,t.axleWorld)},c.prototype.updateWheelTransform=function(t){var e=d,o=v,n=y,l=this.wheelInfos[t];this.updateWheelTransformWorld(l),l.directionLocal.scale(-1,e),o.copy(l.axleLocal),e.cross(o,n),n.normalize(),o.normalize();var h=l.steering,c=new r;c.setFromAxisAngle(e,h);var f=new r;f.setFromAxisAngle(o,l.rotation);var q=l.worldTransform.quaternion;this.chassisBody.quaternion.mult(c,q),q.mult(f,q),q.normalize();var p=l.worldTransform.position;p.copy(l.directionWorld),p.scale(l.suspensionLength,p),p.vadd(l.chassisConnectionPointWorld,p)};var w=[new n(1,0,0),new n(0,1,0),new n(0,0,1)];c.prototype.getWheelTransformWorld=function(t){return this.wheelInfos[t].worldTransform};var x=new n,B=[],E=[],A=1;c.prototype.updateFriction=function(t){for(var e=x,o=this.wheelInfos,r=o.length,l=this.chassisBody,h=E,c=B,i=0;i<r;i++)S=(W=o[i]).raycastResult.body,W.sideImpulse=0,W.forwardImpulse=0,h[i]||(h[i]=new n),c[i]||(c[i]=new n);for(i=0;i<r;i++)if(S=(W=o[i]).raycastResult.body){var d=c[i];this.getWheelTransformWorld(i).vectorToWorldFrame(w[this.indexRightAxis],d);var v=W.raycastResult.hitNormalWorld,y=d.dot(v);v.scale(y,e),d.vsub(e,d),d.normalize(),v.cross(d,h[i]),h[i].normalize(),W.sideImpulse=L(l,W.raycastResult.hitPointWorld,S,W.raycastResult.hitPointWorld,d),W.sideImpulse*=A}var f=1,m=.5;for(this.sliding=!1,i=0;i<r;i++){var S=(W=o[i]).raycastResult.body,C=0;if(W.slipInfo=1,S){var z=0,M=W.brake?W.brake:z;C=R(l,S,W.raycastResult.hitPointWorld,h[i],M);var P=M/(C+=W.engineForce*t);W.slipInfo*=P}if(W.forwardImpulse=0,W.skidInfo=1,S){W.skidInfo=1;var F=W.suspensionForce*t*W.frictionSlip,V=F*F;W.forwardImpulse=C;var T=W.forwardImpulse*m,N=W.sideImpulse*f,I=T*T+N*N;W.sliding=!1,I>V&&(this.sliding=!0,W.sliding=!0,P=F/Math.sqrt(I),W.skidInfo*=P)}}if(this.sliding)for(i=0;i<r;i++)0!==(W=o[i]).sideImpulse&&W.skidInfo<1&&(W.forwardImpulse*=W.skidInfo,W.sideImpulse*=W.skidInfo);for(i=0;i<r;i++){var W=o[i],j=new n;if(j.copy(W.raycastResult.hitPointWorld),0!==W.forwardImpulse){var O=new n;h[i].scale(W.forwardImpulse,O),l.applyImpulse(O,j)}if(0!==W.sideImpulse){S=W.raycastResult.body;var k=new n;k.copy(W.raycastResult.hitPointWorld);var _=new n;c[i].scale(W.sideImpulse,_),l.pointToLocalFrame(j,j),j["xyz"[this.indexUpAxis]]*=W.rollInfluence,l.pointToWorldFrame(j,j),l.applyImpulse(_,j),_.scale(-1,_),S.applyImpulse(_,k)}}};var S=new n,C=new n,z=new n;function R(t,e,o,n,r){var l=0,h=o,c=S,d=C,v=z;return t.getVelocityAtWorldPoint(h,c),e.getVelocityAtWorldPoint(h,d),c.vsub(d,v),r<(l=-n.dot(v)*(1/(T(t,o,n)+T(e,o,n))))&&(l=r),l<-r&&(l=-r),l}var M=new n,P=new n,F=new n,V=new n;function T(body,t,e){var o=M,n=P,r=F,l=V;return t.vsub(body.position,o),o.cross(e,n),body.invInertiaWorld.vmult(n,l),l.cross(o,r),body.invMass+e.dot(r)}var N=new n,I=new n,W=new n;function L(t,e,o,n,r,l){if(r.norm2()>1.1)return 0;var h=N,c=I,d=W;return t.getVelocityAtWorldPoint(e,h),o.getVelocityAtWorldPoint(n,c),h.vsub(c,d),-.2*r.dot(d)*(1/(t.invMass+o.invMass))}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(t,e,o){var n=t("./Body"),r=t("../shapes/Sphere"),l=t("../shapes/Box"),h=t("../math/Vec3"),c=t("../constraints/HingeConstraint");function d(t){if(this.wheelBodies=[],this.coordinateSystem=void 0===t.coordinateSystem?new h(1,2,3):t.coordinateSystem.clone(),this.chassisBody=t.chassisBody,!this.chassisBody){var e=new l(new h(5,2,.5));this.chassisBody=new n(1,e)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}e.exports=d,d.prototype.addWheel=function(t){var e=(t=t||{}).body;e||(e=new n(1,new r(1.2))),this.wheelBodies.push(e),this.wheelForces.push(0),new h;var o=void 0!==t.position?t.position.clone():new h,l=new h;this.chassisBody.pointToWorldFrame(o,l),e.position.set(l.x,l.y,l.z);var d=void 0!==t.axis?t.axis.clone():new h(0,1,0);this.wheelAxes.push(d);var v=new c(this.chassisBody,e,{pivotA:o,axisA:d,pivotB:h.ZERO,axisB:d,collideConnected:!1});return this.constraints.push(v),this.wheelBodies.length-1},d.prototype.setSteeringValue=function(t,e){var o=this.wheelAxes[e],n=Math.cos(t),s=Math.sin(t),r=o.x,l=o.y;this.constraints[e].axisA.set(n*r-s*l,s*r+n*l,0)},d.prototype.setMotorSpeed=function(t,e){var o=this.constraints[e];o.enableMotor(),o.motorTargetVelocity=t},d.prototype.disableMotor=function(t){this.constraints[t].disableMotor()};var v=new h;d.prototype.setWheelForce=function(t,e){this.wheelForces[e]=t},d.prototype.applyWheelForce=function(t,e){var o=this.wheelAxes[e],n=this.wheelBodies[e],r=n.torque;o.scale(t,v),n.vectorToWorldFrame(v,v),r.vadd(v,r)},d.prototype.addToWorld=function(t){for(var e=this.constraints,o=this.wheelBodies.concat([this.chassisBody]),i=0;i<o.length;i++)t.add(o[i]);for(i=0;i<e.length;i++)t.addConstraint(e[i]);t.addEventListener("preStep",this._update.bind(this))},d.prototype._update=function(){for(var t=this.wheelForces,i=0;i<t.length;i++)this.applyWheelForce(t[i],i)},d.prototype.removeFromWorld=function(t){for(var e=this.constraints,o=this.wheelBodies.concat([this.chassisBody]),i=0;i<o.length;i++)t.remove(o[i]);for(i=0;i<e.length;i++)t.removeConstraint(e[i])};var y=new h;d.prototype.getWheelSpeed=function(t){var e=this.wheelAxes[t],o=this.wheelBodies[t].angularVelocity;return this.chassisBody.vectorToWorldFrame(e,y),o.dot(y)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(t,e,o){e.exports=r,t("../shapes/Shape");var n=t("../math/Vec3");function r(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}t("../math/Quaternion"),t("../shapes/Particle"),t("../objects/Body"),t("../material/Material"),r.prototype.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},r.prototype.remove=function(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var l=new n;r.prototype.getNeighbors=function(t,e){for(var o=this.particles.length,n=t.id,r=this.smoothingRadius*this.smoothingRadius,h=l,i=0;i!==o;i++){var p=this.particles[i];p.position.vsub(t.position,h),n!==p.id&&h.norm2()<r&&e.push(p)}};var h=new n,c=new n,d=new n,v=new n,y=new n,f=new n;r.prototype.update=function(){for(var t=this.particles.length,e=h,o=this.speedOfSound,n=this.eps,i=0;i!==t;i++){var p=this.particles[i];(R=this.neighbors[i]).length=0,this.getNeighbors(p,R),R.push(this.particles[i]);for(var r=R.length,l=0,m=0;m!==r;m++){p.position.vsub(R[m].position,e);var w=e.norm(),x=this.w(w);l+=R[m].mass*x}this.densities[i]=l,this.pressures[i]=o*o*(this.densities[i]-this.density)}var B=c,E=d,A=v,S=y,u=f;for(i=0;i!==t;i++){var C,z,R,M=this.particles[i];for(B.set(0,0,0),E.set(0,0,0),r=(R=this.neighbors[i]).length,m=0;m!==r;m++){var P=R[m];M.position.vsub(P.position,S);var F=S.norm();C=-P.mass*(this.pressures[i]/(this.densities[i]*this.densities[i]+n)+this.pressures[m]/(this.densities[m]*this.densities[m]+n)),this.gradw(S,A),A.mult(C,A),B.vadd(A,B),P.velocity.vsub(M.velocity,u),u.mult(1/(1e-4+this.densities[i]*this.densities[m])*this.viscosity*P.mass,u),z=this.nablaw(F),u.mult(z,u),E.vadd(u,E)}E.mult(M.mass,E),B.mult(M.mass,B),M.force.vadd(E,M.force),M.force.vadd(B,M.force)}},r.prototype.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},r.prototype.gradw=function(t,e){var o=t.norm(),n=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-o*o,2),e)},r.prototype.nablaw=function(t){var e=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(t,e,o){var n=t("../math/Vec3");function r(t,e,o){o=o||{},this.restLength="number"==typeof o.restLength?o.restLength:1,this.stiffness=o.stiffness||100,this.damping=o.damping||1,this.bodyA=t,this.bodyB=e,this.localAnchorA=new n,this.localAnchorB=new n,o.localAnchorA&&this.localAnchorA.copy(o.localAnchorA),o.localAnchorB&&this.localAnchorB.copy(o.localAnchorB),o.worldAnchorA&&this.setWorldAnchorA(o.worldAnchorA),o.worldAnchorB&&this.setWorldAnchorB(o.worldAnchorB)}e.exports=r,r.prototype.setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)},r.prototype.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)},r.prototype.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)},r.prototype.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)};var l=new n,h=new n,c=new n,d=new n,v=new n,y=new n,f=new n,m=new n,w=new n,x=new n,B=new n;r.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,o=this.restLength,n=this.bodyA,r=this.bodyB,E=l,A=h,u=c,S=d,C=B,z=v,R=y,M=f,P=m,F=w,V=x;this.getWorldAnchorA(z),this.getWorldAnchorB(R),z.vsub(n.position,M),R.vsub(r.position,P),R.vsub(z,E);var T=E.norm();A.copy(E),A.normalize(),r.velocity.vsub(n.velocity,u),r.angularVelocity.cross(P,C),u.vadd(C,u),n.angularVelocity.cross(M,C),u.vsub(C,u),A.mult(-t*(T-o)-e*u.dot(A),S),n.force.vsub(S,n.force),r.force.vadd(S,r.force),M.cross(S,F),P.cross(S,V),n.torque.vsub(F,n.torque),r.torque.vadd(V,r.torque)}},{"../math/Vec3":30}],36:[function(t,e,o){var n=t("../math/Vec3"),r=t("../math/Transform"),l=t("../collision/RaycastResult"),h=t("../utils/Utils");function c(t){t=h.defaults(t,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new l,this.worldTransform=new r,this.isInContact=!1}e.exports=c;var d=new n,v=new n;d=new n,c.prototype.updateWheel=function(t){var e=this.raycastResult;if(this.isInContact){var o=e.hitNormalWorld.dot(e.directionWorld);e.hitPointWorld.vsub(t.position,v),t.getVelocityAtWorldPoint(v,d);var n=e.hitNormalWorld.dot(d);if(o>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/o;this.suspensionRelativeVelocity=n*r,this.clippedInvContactDotSuspension=r}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(t,e,o){e.exports=h;var n=t("./Shape"),r=t("../math/Vec3"),l=t("./ConvexPolyhedron");function h(t){n.call(this),this.type=n.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}h.prototype=new n,h.prototype.constructor=h,h.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,e=this.halfExtents.y,o=this.halfExtents.z,n=r,h=[new n(-t,-e,-o),new n(t,-e,-o),new n(t,e,-o),new n(-t,e,-o),new n(-t,-e,o),new n(t,-e,o),new n(t,e,o),new n(-t,e,o)],c=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],d=(new n(0,0,1),new n(0,1,0),new n(1,0,0),new l(h,c));this.convexPolyhedronRepresentation=d,d.material=this.material},h.prototype.calculateLocalInertia=function(t,e){return e=e||new r,h.calculateInertia(this.halfExtents,t,e),e},h.calculateInertia=function(t,e,o){var n=t;o.x=1/12*e*(2*n.y*2*n.y+2*n.z*2*n.z),o.y=1/12*e*(2*n.x*2*n.x+2*n.z*2*n.z),o.z=1/12*e*(2*n.y*2*n.y+2*n.x*2*n.x)},h.prototype.getSideNormals=function(t,e){var o=t,n=this.halfExtents;if(o[0].set(n.x,0,0),o[1].set(0,n.y,0),o[2].set(0,0,n.z),o[3].set(-n.x,0,0),o[4].set(0,-n.y,0),o[5].set(0,0,-n.z),void 0!==e)for(var i=0;i!==o.length;i++)e.vmult(o[i],o[i]);return o},h.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},h.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var c=new r;new r,h.prototype.forEachWorldCorner=function(t,e,o){for(var n=this.halfExtents,r=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],i=0;i<r.length;i++)c.set(r[i][0],r[i][1],r[i][2]),e.vmult(c,c),t.vadd(c,c),o(c.x,c.y,c.z)};var d=[new r,new r,new r,new r,new r,new r,new r,new r];h.prototype.calculateWorldAABB=function(t,e,o,n){var r=this.halfExtents;d[0].set(r.x,r.y,r.z),d[1].set(-r.x,r.y,r.z),d[2].set(-r.x,-r.y,r.z),d[3].set(-r.x,-r.y,-r.z),d[4].set(r.x,-r.y,-r.z),d[5].set(r.x,r.y,-r.z),d[6].set(-r.x,r.y,-r.z),d[7].set(r.x,-r.y,r.z);var l=d[0];e.vmult(l,l),t.vadd(l,l),n.copy(l),o.copy(l);for(var i=1;i<8;i++){l=d[i],e.vmult(l,l),t.vadd(l,l);var h=l.x,c=l.y,v=l.z;h>n.x&&(n.x=h),c>n.y&&(n.y=c),v>n.z&&(n.z=v),h<o.x&&(o.x=h),c<o.y&&(o.y=c),v<o.z&&(o.z=v)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(t,e,o){e.exports=h;var n=t("./Shape"),r=t("../math/Vec3"),l=(t("../math/Quaternion"),t("../math/Transform"));function h(t,e,o){n.call(this),this.type=n.types.CONVEXPOLYHEDRON,this.vertices=t||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=e||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=o?o.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}h.prototype=new n,h.prototype.constructor=h;var c=new r;h.prototype.computeEdges=function(){var t=this.faces,e=this.vertices,o=(e.length,this.uniqueEdges);o.length=0;for(var n=c,i=0;i!==t.length;i++)for(var r=t[i],l=r.length,h=0;h!==l;h++){var d=(h+1)%l;e[r[h]].vsub(e[r[d]],n),n.normalize();for(var v=!1,p=0;p!==o.length;p++)if(o[p].almostEquals(n)||o[p].almostEquals(n)){v=!0;break}v||o.push(n.clone())}},h.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var i=0;i<this.faces.length;i++){for(var t=0;t<this.faces[i].length;t++)if(!this.vertices[this.faces[i][t]])throw new Error("Vertex "+this.faces[i][t]+" not found!");var e=this.faceNormals[i]||new r;this.getFaceNormal(i,e),e.negate(e),this.faceNormals[i]=e;var o=this.vertices[this.faces[i][0]];if(e.dot(o)<0)for(console.error(".faceNormals["+i+"] = Vec3("+e.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),t=0;t<this.faces[i].length;t++)console.warn(".vertices["+this.faces[i][t]+"] = Vec3("+this.vertices[this.faces[i][t]].toString()+")")}};var d=new r,v=new r;h.computeNormal=function(t,e,o,n){e.vsub(t,v),o.vsub(e,d),d.cross(v,n),n.isZero()||n.normalize()},h.prototype.getFaceNormal=function(i,t){var e=this.faces[i],o=this.vertices[e[0]],n=this.vertices[e[1]],r=this.vertices[e[2]];return h.computeNormal(o,n,r,t)};var y=new r;h.prototype.clipAgainstHull=function(t,e,o,n,l,h,c,d,v){for(var f=y,m=-1,w=-Number.MAX_VALUE,x=0;x<o.faces.length;x++){f.copy(o.faceNormals[x]),l.vmult(f,f);var B=f.dot(h);B>w&&(w=B,m=x)}for(var E=[],A=o.faces[m],S=A.length,C=0;C<S;C++){var b=o.vertices[A[C]],z=new r;z.copy(b),l.vmult(z,z),n.vadd(z,z),E.push(z)}m>=0&&this.clipFaceAgainstHull(h,t,e,E,c,d,v)};var f=new r,m=new r,w=new r,x=new r,B=new r,E=new r;h.prototype.findSeparatingAxis=function(t,e,o,n,r,l,h,c){var d=f,v=m,y=w,A=x,S=B,C=E,z=Number.MAX_VALUE,R=this;if(R.uniqueAxes)for(i=0;i!==R.uniqueAxes.length;i++){if(o.vmult(R.uniqueAxes[i],d),!1===(V=R.testSepAxis(d,t,e,o,n,r)))return!1;V<z&&(z=V,l.copy(d))}else for(var M=h?h.length:R.faces.length,i=0;i<M;i++){var P=h?h[i]:i;if(d.copy(R.faceNormals[P]),o.vmult(d,d),!1===(V=R.testSepAxis(d,t,e,o,n,r)))return!1;V<z&&(z=V,l.copy(d))}if(t.uniqueAxes)for(i=0;i!==t.uniqueAxes.length;i++){if(r.vmult(t.uniqueAxes[i],v),!1===(V=R.testSepAxis(v,t,e,o,n,r)))return!1;V<z&&(z=V,l.copy(v))}else for(var F=c?c.length:t.faces.length,i=0;i<F;i++){var V;if(P=c?c[i]:i,v.copy(t.faceNormals[P]),r.vmult(v,v),!1===(V=R.testSepAxis(v,t,e,o,n,r)))return!1;V<z&&(z=V,l.copy(v))}for(var T=0;T!==R.uniqueEdges.length;T++){o.vmult(R.uniqueEdges[T],A);for(var N=0;N!==t.uniqueEdges.length;N++)if(r.vmult(t.uniqueEdges[N],S),A.cross(S,C),!C.almostZero()){C.normalize();var I=R.testSepAxis(C,t,e,o,n,r);if(!1===I)return!1;I<z&&(z=I,l.copy(C))}}return n.vsub(e,y),y.dot(l)>0&&l.negate(l),!0};var A=[],S=[];h.prototype.testSepAxis=function(t,e,o,n,r,l){var c=this;h.project(c,t,o,n,A),h.project(e,t,r,l,S);var d=A[0],v=A[1],y=S[0],f=S[1];if(d<f||y<v)return!1;var m=d-f,w=y-v;return m<w?m:w};var C=new r,z=new r;h.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(C,z);var o=z.x-C.x,n=z.y-C.y,r=z.z-C.z;e.x=1/12*t*(2*n*2*n+2*r*2*r),e.y=1/12*t*(2*o*2*o+2*r*2*r),e.z=1/12*t*(2*n*2*n+2*o*2*o)},h.prototype.getPlaneConstantOfFace=function(t){var e=this.faces[t],o=this.faceNormals[t],n=this.vertices[e[0]];return-o.dot(n)};var R=new r,M=new r,P=new r,F=new r,V=new r,T=new r,N=new r,I=new r;h.prototype.clipFaceAgainstHull=function(t,e,o,n,r,l,h){for(var c=R,d=M,v=P,y=F,f=V,m=T,w=N,x=I,B=this,E=n,A=[],S=-1,C=Number.MAX_VALUE,z=0;z<B.faces.length;z++){c.copy(B.faceNormals[z]),o.vmult(c,c);var W=c.dot(t);W<C&&(C=W,S=z)}if(!(S<0)){var L=B.faces[S];L.connectedFaces=[];for(var i=0;i<B.faces.length;i++)for(var j=0;j<B.faces[i].length;j++)-1!==L.indexOf(B.faces[i][j])&&i!==S&&-1===L.connectedFaces.indexOf(i)&&L.connectedFaces.push(i);E.length;for(var O=L.length,k=0;k<O;k++){var a=B.vertices[L[k]],b=B.vertices[L[(k+1)%O]];a.vsub(b,d),v.copy(d),o.vmult(v,v),e.vadd(v,v),y.copy(this.faceNormals[S]),o.vmult(y,y),e.vadd(y,y),v.cross(y,f),f.negate(f),m.copy(a),o.vmult(m,m),e.vadd(m,m),m.dot(f);var _=L.connectedFaces[k];w.copy(this.faceNormals[_]);var U=this.getPlaneConstantOfFace(_);x.copy(w),o.vmult(x,x);var H=U-x.dot(e);for(this.clipFaceAgainstPlane(E,A,x,H);E.length;)E.shift();for(;A.length;)E.push(A.shift())}for(w.copy(this.faceNormals[S]),U=this.getPlaneConstantOfFace(S),x.copy(w),o.vmult(x,x),H=U-x.dot(e),i=0;i<E.length;i++){var D=x.dot(E[i])+H;if(D<=r&&(console.log("clamped: depth="+D+" to minDist="+r),D=r),D<=l){var X=E[i];if(D<=0){var p={point:X,normal:x,depth:D};h.push(p)}}}}},h.prototype.clipFaceAgainstPlane=function(t,e,o,n){var l,h,c=t.length;if(c<2)return e;var d=t[t.length-1],v=t[0];l=o.dot(d)+n;for(var y=0;y<c;y++){if(v=t[y],h=o.dot(v)+n,l<0)if(h<0)(f=new r).copy(v),e.push(f);else{var f=new r;d.lerp(v,l/(l-h),f),e.push(f)}else h<0&&(f=new r,d.lerp(v,l/(l-h),f),e.push(f),e.push(v));d=v,l=h}return e},h.prototype.computeWorldVertices=function(t,e){for(var o=this.vertices.length;this.worldVertices.length<o;)this.worldVertices.push(new r);for(var n=this.vertices,l=this.worldVertices,i=0;i!==o;i++)e.vmult(n[i],l[i]),t.vadd(l[i],l[i]);this.worldVerticesNeedsUpdate=!1},new r,h.prototype.computeLocalAABB=function(t,e){var o=this.vertices.length,n=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var i=0;i<o;i++){var r=n[i];r.x<t.x?t.x=r.x:r.x>e.x&&(e.x=r.x),r.y<t.y?t.y=r.y:r.y>e.y&&(e.y=r.y),r.z<t.z?t.z=r.z:r.z>e.z&&(e.z=r.z)}},h.prototype.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new r);for(var o=this.faceNormals,n=this.worldFaceNormals,i=0;i!==e;i++)t.vmult(o[i],n[i]);this.worldFaceNormalsNeedsUpdate=!1},h.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0,o=e.length;i!==o;i++){var n=e[i].norm2();n>t&&(t=n)}this.boundingSphereRadius=Math.sqrt(t)};var W=new r;h.prototype.calculateWorldAABB=function(t,e,o,n){for(var r,l,h,c,d,v,y=this.vertices.length,f=this.vertices,i=0;i<y;i++){W.copy(f[i]),e.vmult(W,W),t.vadd(W,W);var m=W;m.x<r||void 0===r?r=m.x:(m.x>c||void 0===c)&&(c=m.x),m.y<l||void 0===l?l=m.y:(m.y>d||void 0===d)&&(d=m.y),m.z<h||void 0===h?h=m.z:(m.z>v||void 0===v)&&(v=m.z)}o.set(r,l,h),n.set(c,d,v)},h.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},h.prototype.getAveragePointLocal=function(t){t=t||new r;for(var e=this.vertices.length,o=this.vertices,i=0;i<e;i++)t.vadd(o[i],t);return t.mult(1/e,t),t},h.prototype.transformAllPoints=function(t,e){var o=this.vertices.length,n=this.vertices;if(e){for(var i=0;i<o;i++){var r=n[i];e.vmult(r,r)}for(i=0;i<this.faceNormals.length;i++)r=this.faceNormals[i],e.vmult(r,r)}if(t)for(i=0;i<o;i++)(r=n[i]).vadd(t,r)};var L=new r,j=new r,O=new r;h.prototype.pointIsInside=function(p){var t=this.vertices.length,e=this.vertices,o=this.faces,n=this.faceNormals,r=null,l=this.faces.length,h=L;this.getAveragePointLocal(h);for(var i=0;i<l;i++){this.faces[i].length,t=n[i];var c=e[o[i][0]],d=j;p.vsub(c,d);var v=t.dot(d),y=O;h.vsub(c,y);var f=t.dot(y);if(v<0&&f>0||v>0&&f<0)return!1}return r?1:-1},new r;var k=new r,_=new r;h.project=function(t,e,o,n,r){var h=t.vertices.length,c=k,d=0,v=0,y=_,f=t.vertices;y.setZero(),l.vectorToLocalFrame(o,n,e,c),l.pointToLocalFrame(o,n,y,y);var m=y.dot(c);v=d=f[0].dot(c);for(var i=1;i<h;i++){var w=f[i].dot(c);w>d&&(d=w),w<v&&(v=w)}if((v-=m)>(d-=m)){var x=v;v=d,d=x}r[0]=d,r[1]=v}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(t,e,o){e.exports=h;var n=t("./Shape"),r=t("../math/Vec3"),l=(t("../math/Quaternion"),t("./ConvexPolyhedron"));function h(t,e,o,h){var c=h,d=[],v=[],y=[],f=[],m=[],w=Math.cos,x=Math.sin;d.push(new r(e*w(0),e*x(0),.5*-o)),f.push(0),d.push(new r(t*w(0),t*x(0),.5*o)),m.push(1);for(var i=0;i<c;i++){var B=2*Math.PI/c*(i+1),E=2*Math.PI/c*(i+.5);i<c-1?(d.push(new r(e*w(B),e*x(B),.5*-o)),f.push(2*i+2),d.push(new r(t*w(B),t*x(B),.5*o)),m.push(2*i+3),y.push([2*i+2,2*i+3,2*i+1,2*i])):y.push([0,1,2*i+1,2*i]),(c%2==1||i<c/2)&&v.push(new r(w(E),x(E),0))}y.push(m),v.push(new r(0,0,1));var A=[];for(i=0;i<f.length;i++)A.push(f[f.length-i-1]);y.push(A),this.type=n.types.CONVEXPOLYHEDRON,l.call(this,d,y,v)}h.prototype=new l},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(t,e,o){var n=t("./Shape"),r=t("./ConvexPolyhedron"),l=t("../math/Vec3"),h=t("../utils/Utils");function c(data,t){t=h.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=data,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this),this.pillarConvex=new r,this.pillarOffset=new l,this.type=n.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}e.exports=c,c.prototype=new n,c.prototype.update=function(){this._cachedPillars={}},c.prototype.updateMinValue=function(){for(var data=this.data,t=data[0][0],i=0;i!==data.length;i++)for(var e=0;e!==data[i].length;e++){var o=data[i][e];o<t&&(t=o)}this.minValue=t},c.prototype.updateMaxValue=function(){for(var data=this.data,t=data[0][0],i=0;i!==data.length;i++)for(var e=0;e!==data[i].length;e++){var o=data[i][e];o>t&&(t=o)}this.maxValue=t},c.prototype.setHeightValueAtIndex=function(t,e,o){this.data[t][e]=o,this.clearCachedConvexTrianglePillar(t,e,!1),t>0&&(this.clearCachedConvexTrianglePillar(t-1,e,!0),this.clearCachedConvexTrianglePillar(t-1,e,!1)),e>0&&(this.clearCachedConvexTrianglePillar(t,e-1,!0),this.clearCachedConvexTrianglePillar(t,e-1,!1)),e>0&&t>0&&this.clearCachedConvexTrianglePillar(t-1,e-1,!0)},c.prototype.getRectMinMax=function(t,e,o,n,r){r=r||[];for(var data=this.data,l=this.minValue,i=t;i<=o;i++)for(var h=e;h<=n;h++){var c=data[i][h];c>l&&(l=c)}r[0]=this.minValue,r[1]=l},c.prototype.getIndexOfPosition=function(t,e,o,n){var r=this.elementSize,data=this.data,l=Math.floor(t/r),h=Math.floor(e/r);return o[0]=l,o[1]=h,n&&(l<0&&(l=0),h<0&&(h=0),l>=data.length-1&&(l=data.length-1),h>=data[0].length-1&&(h=data[0].length-1)),!(l<0||h<0||l>=data.length-1||h>=data[0].length-1)},c.prototype.getHeightAt=function(t,e,o){var n=[];this.getIndexOfPosition(t,e,n,o);var r=[];return this.getRectMinMax(n[0],n[1]+1,n[0],n[1]+1,r),(r[0]+r[1])/2},c.prototype.getCacheConvexTrianglePillarKey=function(t,e,o){return t+"_"+e+"_"+(o?1:0)},c.prototype.getCachedConvexTrianglePillar=function(t,e,o){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,o)]},c.prototype.setCachedConvexTrianglePillar=function(t,e,o,n,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,o)]={convex:n,offset:r}},c.prototype.clearCachedConvexTrianglePillar=function(t,e,o){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,o)]},c.prototype.getConvexTrianglePillar=function(t,e,o){var n=this.pillarConvex,h=this.pillarOffset;if(this.cacheEnabled){if(data=this.getCachedConvexTrianglePillar(t,e,o))return this.pillarConvex=data.convex,void(this.pillarOffset=data.offset);n=new r,h=new l,this.pillarConvex=n,this.pillarOffset=h}var data=this.data,c=this.elementSize,d=n.faces;n.vertices.length=6;for(var i=0;i<6;i++)n.vertices[i]||(n.vertices[i]=new l);for(d.length=5,i=0;i<5;i++)d[i]||(d[i]=[]);var v=n.vertices,y=(Math.min(data[t][e],data[t+1][e],data[t][e+1],data[t+1][e+1])-this.minValue)/2+this.minValue;o?(h.set((t+.75)*c,(e+.75)*c,y),v[0].set(.25*c,.25*c,data[t+1][e+1]-y),v[1].set(-.75*c,.25*c,data[t][e+1]-y),v[2].set(.25*c,-.75*c,data[t+1][e]-y),v[3].set(.25*c,.25*c,-y-1),v[4].set(-.75*c,.25*c,-y-1),v[5].set(.25*c,-.75*c,-y-1),d[0][0]=0,d[0][1]=1,d[0][2]=2,d[1][0]=5,d[1][1]=4,d[1][2]=3,d[2][0]=2,d[2][1]=5,d[2][2]=3,d[2][3]=0,d[3][0]=3,d[3][1]=4,d[3][2]=1,d[3][3]=0,d[4][0]=1,d[4][1]=4,d[4][2]=5,d[4][3]=2):(h.set((t+.25)*c,(e+.25)*c,y),v[0].set(-.25*c,-.25*c,data[t][e]-y),v[1].set(.75*c,-.25*c,data[t+1][e]-y),v[2].set(-.25*c,.75*c,data[t][e+1]-y),v[3].set(-.25*c,-.25*c,-y-1),v[4].set(.75*c,-.25*c,-y-1),v[5].set(-.25*c,.75*c,-y-1),d[0][0]=0,d[0][1]=1,d[0][2]=2,d[1][0]=5,d[1][1]=4,d[1][2]=3,d[2][0]=0,d[2][1]=2,d[2][2]=5,d[2][3]=3,d[3][0]=1,d[3][1]=0,d[3][2]=3,d[3][3]=4,d[4][0]=4,d[4][1]=5,d[4][2]=2,d[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(t,e,o,n,h)},c.prototype.calculateLocalInertia=function(t,e){return(e=e||new l).set(0,0,0),e},c.prototype.volume=function(){return Number.MAX_VALUE},c.prototype.calculateWorldAABB=function(t,e,o,n){o.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},c.prototype.updateBoundingSphereRadius=function(){var data=this.data,s=this.elementSize;this.boundingSphereRadius=new l(data.length*s,data[0].length*s,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(t,e,o){e.exports=l;var n=t("./Shape"),r=t("../math/Vec3");function l(){n.call(this),this.type=n.types.PARTICLE}l.prototype=new n,l.prototype.constructor=l,l.prototype.calculateLocalInertia=function(t,e){return(e=e||new r).set(0,0,0),e},l.prototype.volume=function(){return 0},l.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},l.prototype.calculateWorldAABB=function(t,e,o,n){o.copy(t),n.copy(t)}},{"../math/Vec3":30,"./Shape":43}],42:[function(t,e,o){e.exports=l;var n=t("./Shape"),r=t("../math/Vec3");function l(){n.call(this),this.type=n.types.PLANE,this.worldNormal=new r,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}l.prototype=new n,l.prototype.constructor=l,l.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},l.prototype.calculateLocalInertia=function(t,e){return e=e||new r},l.prototype.volume=function(){return Number.MAX_VALUE};var h=new r;l.prototype.calculateWorldAABB=function(t,e,o,n){h.set(0,0,1),e.vmult(h,h);var r=Number.MAX_VALUE;o.set(-r,-r,-r),n.set(r,r,r),1===h.x&&(n.x=t.x),1===h.y&&(n.y=t.y),1===h.z&&(n.z=t.z),-1===h.x&&(o.x=t.x),-1===h.y&&(o.y=t.y),-1===h.z&&(o.z=t.z)},l.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(t,e,o){e.exports=n;var n=t("./Shape");function n(){this.id=n.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}t("../math/Vec3"),t("../math/Quaternion"),t("../material/Material"),n.prototype.constructor=n,n.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},n.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},n.prototype.calculateLocalInertia=function(t,e){throw"calculateLocalInertia() not implemented for shape type "+this.type},n.idCounter=0,n.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(t,e,o){e.exports=l;var n=t("./Shape"),r=t("../math/Vec3");function l(t){if(n.call(this),this.radius=void 0!==t?Number(t):1,this.type=n.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}l.prototype=new n,l.prototype.constructor=l,l.prototype.calculateLocalInertia=function(t,e){e=e||new r;var o=2*t*this.radius*this.radius/5;return e.x=o,e.y=o,e.z=o,e},l.prototype.volume=function(){return 4*Math.PI*this.radius/3},l.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},l.prototype.calculateWorldAABB=function(t,e,o,n){for(var r=this.radius,l=["x","y","z"],i=0;i<l.length;i++){var h=l[i];o[h]=t[h]-r,n[h]=t[h]+r}}},{"../math/Vec3":30,"./Shape":43}],45:[function(t,e,o){e.exports=d;var n=t("./Shape"),r=t("../math/Vec3"),l=(t("../math/Quaternion"),t("../math/Transform")),h=t("../collision/AABB"),c=t("../utils/Octree");function d(t,e){n.call(this),this.type=n.types.TRIMESH,this.vertices=new Float32Array(t),this.indices=new Int16Array(e),this.normals=new Float32Array(e.length),this.aabb=new h,this.edges=null,this.scale=new r(1,1,1),this.tree=new c,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}d.prototype=new n,d.prototype.constructor=d;var v=new r;d.prototype.updateTree=function(){var t=this.tree;t.reset(),t.aabb.copy(this.aabb);var e=this.scale;t.aabb.lowerBound.x*=1/e.x,t.aabb.lowerBound.y*=1/e.y,t.aabb.lowerBound.z*=1/e.z,t.aabb.upperBound.x*=1/e.x,t.aabb.upperBound.y*=1/e.y,t.aabb.upperBound.z*=1/e.z;for(var o=new h,a=new r,b=new r,n=new r,l=[a,b,n],i=0;i<this.indices.length/3;i++){var c=3*i;this._getUnscaledVertex(this.indices[c],a),this._getUnscaledVertex(this.indices[c+1],b),this._getUnscaledVertex(this.indices[c+2],n),o.setFromPoints(l),t.insert(o,i)}t.removeEmptyNodes()};var y=new h;d.prototype.getTrianglesInAABB=function(t,e){y.copy(t);var o=this.scale,n=o.x,r=o.y,l=o.z,h=y.lowerBound,u=y.upperBound;return h.x/=n,h.y/=r,h.z/=l,u.x/=n,u.y/=r,u.z/=l,this.tree.aabbQuery(y,e)},d.prototype.setScale=function(t){var e=this.scale.x===this.scale.y===this.scale.z,o=t.x===t.y===t.z;e&&o||this.updateNormals(),this.scale.copy(t),this.updateAABB(),this.updateBoundingSphereRadius()},d.prototype.updateNormals=function(){for(var t=v,e=this.normals,i=0;i<this.indices.length/3;i++){var o=3*i,a=this.indices[o],b=this.indices[o+1],n=this.indices[o+2];this.getVertex(a,B),this.getVertex(b,E),this.getVertex(n,A),d.computeNormal(E,B,A,t),e[o]=t.x,e[o+1]=t.y,e[o+2]=t.z}},d.prototype.updateEdges=function(){for(var t={},e=function(e,o){t[a<b?a+"_"+b:b+"_"+a]=!0},i=0;i<this.indices.length/3;i++){var o=3*i,a=this.indices[o],b=this.indices[o+1],n=this.indices[o+2];e(a,b),e(b,n),e(n,a)}var r=Object.keys(t);for(this.edges=new Int16Array(2*r.length),i=0;i<r.length;i++){var l=r[i].split("_");this.edges[2*i]=parseInt(l[0],10),this.edges[2*i+1]=parseInt(l[1],10)}},d.prototype.getEdgeVertex=function(t,e,o){var n=this.edges[2*t+(e?1:0)];this.getVertex(n,o)};var f=new r,m=new r;d.prototype.getEdgeVector=function(t,e){var o=f,n=m;this.getEdgeVertex(t,0,o),this.getEdgeVertex(t,1,n),n.vsub(o,e)};var w=new r,x=new r;d.computeNormal=function(t,e,o,n){e.vsub(t,x),o.vsub(e,w),w.cross(x,n),n.isZero()||n.normalize()};var B=new r,E=new r,A=new r;d.prototype.getVertex=function(i,t){var e=this.scale;return this._getUnscaledVertex(i,t),t.x*=e.x,t.y*=e.y,t.z*=e.z,t},d.prototype._getUnscaledVertex=function(i,t){var e=3*i,o=this.vertices;return t.set(o[e],o[e+1],o[e+2])},d.prototype.getWorldVertex=function(i,t,e,o){return this.getVertex(i,o),l.pointToWorldFrame(t,e,o,o),o},d.prototype.getTriangleVertices=function(i,a,b,t){var e=3*i;this.getVertex(this.indices[e],a),this.getVertex(this.indices[e+1],b),this.getVertex(this.indices[e+2],t)},d.prototype.getNormal=function(i,t){var e=3*i;return t.set(this.normals[e],this.normals[e+1],this.normals[e+2])};var S=new h;d.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(S);var o=S.upperBound.x-S.lowerBound.x,n=S.upperBound.y-S.lowerBound.y,r=S.upperBound.z-S.lowerBound.z;return e.set(1/12*t*(2*n*2*n+2*r*2*r),1/12*t*(2*o*2*o+2*r*2*r),1/12*t*(2*n*2*n+2*o*2*o))};var C=new r;d.prototype.computeLocalAABB=function(t){var e=t.lowerBound,u=t.upperBound,o=this.vertices.length,n=(this.vertices,C);this.getVertex(0,n),e.copy(n),u.copy(n);for(var i=0;i!==o;i++)this.getVertex(i,n),n.x<e.x?e.x=n.x:n.x>u.x&&(u.x=n.x),n.y<e.y?e.y=n.y:n.y>u.y&&(u.y=n.y),n.z<e.z?e.z=n.z:n.z>u.z&&(u.z=n.z)},d.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},d.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,o=new r,i=0,n=e.length/3;i!==n;i++){this.getVertex(i,o);var l=o.norm2();l>t&&(t=l)}this.boundingSphereRadius=Math.sqrt(t)},new r;var z=new l,R=new h;d.prototype.calculateWorldAABB=function(t,e,o,n){var r=z,l=R;r.position=t,r.quaternion=e,this.aabb.toWorldFrame(r,l),o.copy(l.lowerBound),n.copy(l.upperBound)},d.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},d.createTorus=function(t,e,o,n,r){t=t||1,e=e||.5,o=o||8,n=n||6,r=r||2*Math.PI;for(var l=[],h=[],c=0;c<=o;c++)for(var i=0;i<=n;i++){var u=i/n*r,v=c/o*Math.PI*2,y=(t+e*Math.cos(v))*Math.cos(u),f=(t+e*Math.cos(v))*Math.sin(u),m=e*Math.sin(v);l.push(y,f,m)}for(c=1;c<=o;c++)for(i=1;i<=n;i++){var a=(n+1)*c+i-1,b=(n+1)*(c-1)+i-1,w=(n+1)*(c-1)+i,x=(n+1)*c+i;h.push(a,b,x),h.push(b,w,x)}return new d(l,h)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(t,e,o){e.exports=r,t("../math/Vec3"),t("../math/Quaternion");var n=t("./Solver");function r(){n.call(this),this.iterations=10,this.tolerance=1e-7}r.prototype=new n;var l=[],h=[],c=[];r.prototype.solve=function(dt,t){var e,o,n,r,d,v=0,y=this.iterations,f=this.tolerance*this.tolerance,m=this.equations,w=m.length,x=t.bodies,B=x.length,E=dt;if(0!==w)for(var i=0;i!==B;i++)x[i].updateSolveMassProperties();var A=h,S=c,C=l;for(A.length=w,S.length=w,C.length=w,i=0;i!==w;i++){var z=m[i];C[i]=0,S[i]=z.computeB(E),A[i]=1/z.computeC()}if(0!==w){for(i=0;i!==B;i++){var R=(b=x[i]).vlambda,M=b.wlambda;R.set(0,0,0),M&&M.set(0,0,0)}for(v=0;v!==y;v++){r=0;for(var P=0;P!==w;P++)z=m[P],e=S[P],o=A[P],(d=C[P])+(n=o*(e-z.computeGWlambda()-z.eps*d))<z.minForce?n=z.minForce-d:d+n>z.maxForce&&(n=z.maxForce-d),C[P]+=n,r+=n>0?n:-n,z.addToWlambda(n);if(r*r<f)break}for(i=0;i!==B;i++){var b,F=(b=x[i]).velocity,V=b.angularVelocity;F.vadd(b.vlambda,F),V&&V.vadd(b.wlambda,V)}}return v}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(t,e,o){function n(){this.equations=[]}e.exports=n,n.prototype.solve=function(dt,t){return 0},n.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)},n.prototype.removeEquation=function(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(t,e,o){e.exports=l,t("../math/Vec3"),t("../math/Quaternion");var n=t("./Solver"),r=t("../objects/Body");function l(t){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=t,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}l.prototype=new n;var h=[],c=[],d={bodies:[]},v=r.STATIC;function y(t){for(var e=t.length,i=0;i!==e;i++){var o=t[i];if(!(o.visited||o.body.type&v))return o}return!1}var f=[];function m(t,e,o,n){for(f.push(t),t.visited=!0,e(t,o,n);f.length;)for(var r,l=f.pop();r=y(l.children);)r.visited=!0,e(r,o,n),f.push(r)}function w(t,e,o){e.push(t.body);for(var n=t.eqs.length,i=0;i!==n;i++){var r=t.eqs[i];-1===o.indexOf(r)&&o.push(r)}}function x(a,b){return b.id-a.id}l.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},l.prototype.solve=function(dt,t){for(var e=h,o=this.nodePool,n=t.bodies,r=this.equations,l=r.length,v=n.length,f=this.subsolver;o.length<v;)o.push(this.createNode());e.length=v;for(var i=0;i<v;i++)e[i]=o[i];for(i=0;i!==v;i++){var B=e[i];B.body=n[i],B.children.length=0,B.eqs.length=0,B.visited=!1}for(var E=0;E!==l;E++){var A=r[E],S=(i=n.indexOf(A.bi),n.indexOf(A.bj)),C=e[i],z=e[S];C.children.push(z),C.eqs.push(A),z.children.push(C),z.eqs.push(A)}var R,M=0,P=c;f.tolerance=this.tolerance,f.iterations=this.iterations;for(var F=d;R=y(e);){P.length=0,F.bodies.length=0,m(R,w,F.bodies,P);var V=P.length;for(P=P.sort(x),i=0;i!==V;i++)f.addEquation(P[i]);f.solve(dt,F),f.removeAllEquations(),M++}return M}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(t,e,o){var n=function(){};e.exports=n,n.prototype={constructor:n,addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var o=this._listeners;return void 0===o[t]&&(o[t]=[]),-1===o[t].indexOf(e)&&o[t].push(e),this},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var o=this._listeners;return void 0!==o[t]&&-1!==o[t].indexOf(e)},removeEventListener:function(t,e){if(void 0===this._listeners)return this;var o=this._listeners;if(void 0===o[t])return this;var n=o[t].indexOf(e);return-1!==n&&o[t].splice(n,1),this},dispatchEvent:function(t){if(void 0===this._listeners)return this;var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=0,o=e.length;i<o;i++)e[i].call(this,t)}return this}}},{}],50:[function(t,e,o){var n=t("../collision/AABB"),r=t("../math/Vec3");function l(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new n,this.data=[],this.children=[]}function h(t,e){(e=e||{}).root=null,e.aabb=t,l.call(this,e),this.maxDepth=void 0!==e.maxDepth?e.maxDepth:8}e.exports=h,h.prototype=new l,l.prototype.reset=function(t,e){this.children.length=this.data.length=0},l.prototype.insert=function(t,e,o){var n=this.data;if(o=o||0,!this.aabb.contains(t))return!1;var r=this.children;if(o<(this.maxDepth||this.root.maxDepth)){var l=!1;r.length||(this.subdivide(),l=!0);for(var i=0;8!==i;i++)if(r[i].insert(t,e,o+1))return!0;l&&(r.length=0)}return n.push(e),!0};var c=new r;l.prototype.subdivide=function(){var t=this.aabb,e=t.lowerBound,u=t.upperBound,o=this.children;o.push(new l({aabb:new n({lowerBound:new r(0,0,0)})}),new l({aabb:new n({lowerBound:new r(1,0,0)})}),new l({aabb:new n({lowerBound:new r(1,1,0)})}),new l({aabb:new n({lowerBound:new r(1,1,1)})}),new l({aabb:new n({lowerBound:new r(0,1,1)})}),new l({aabb:new n({lowerBound:new r(0,0,1)})}),new l({aabb:new n({lowerBound:new r(1,0,1)})}),new l({aabb:new n({lowerBound:new r(0,1,0)})})),u.vsub(e,c),c.scale(.5,c);for(var h=this.root||this,i=0;8!==i;i++){var d=o[i];d.root=h;var v=d.aabb.lowerBound;v.x*=c.x,v.y*=c.y,v.z*=c.z,v.vadd(e,v),v.vadd(c,d.aabb.upperBound)}},l.prototype.aabbQuery=function(t,e){this.data,this.children;for(var o=[this];o.length;){var n=o.pop();n.aabb.overlaps(t)&&Array.prototype.push.apply(e,n.data),Array.prototype.push.apply(o,n.children)}return e};var d=new n;l.prototype.rayQuery=function(t,e,o){return t.getAABB(d),d.toLocalFrame(e,d),this.aabbQuery(d,o),o},l.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var e=t.pop(),i=e.children.length-1;i>=0;i--)e.children[i].data.length||e.children.splice(i,1);Array.prototype.push.apply(t,e.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(t,e,o){function n(){this.objects=[],this.type=Object}e.exports=n,n.prototype.release=function(){for(var t=arguments.length,i=0;i!==t;i++)this.objects.push(arguments[i])},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(t,e,o){function n(){this.data={keys:[]}}e.exports=n,n.prototype.get=function(i,t){if(i>t){var e=t;t=i,i=e}return this.data[i+"-"+t]},n.prototype.set=function(i,t,e){if(i>t){var o=t;t=i,i=o}var n=i+"-"+t;this.get(i,t)||this.data.keys.push(n),this.data[n]=e},n.prototype.reset=function(){for(var data=this.data,t=data.keys;t.length>0;)delete data[t.pop()]}},{}],53:[function(t,e,o){function n(){}e.exports=n,n.defaults=function(t,e){for(var o in t=t||{},e)o in t||(t[o]=e[o]);return t}},{}],54:[function(t,e,o){e.exports=l;var n=t("../math/Vec3"),r=t("./Pool");function l(){r.call(this),this.type=n}l.prototype=new r,l.prototype.constructObject=function(){return new n}},{"../math/Vec3":30,"./Pool":51}],55:[function(t,e,o){e.exports=m;var n=t("../collision/AABB"),r=t("../shapes/Shape"),l=t("../collision/Ray"),h=t("../math/Vec3"),c=t("../math/Transform"),d=(t("../shapes/ConvexPolyhedron"),t("../math/Quaternion")),v=(t("../solver/Solver"),t("../utils/Vec3Pool")),y=t("../equations/ContactEquation"),f=t("../equations/FrictionEquation");function m(t){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new v,this.world=t,this.currentContactMaterial=null,this.enableFrictionReduction=!1}m.prototype.createContactEquation=function(t,e,o,n,r,l){var h;this.contactPointPool.length?((h=this.contactPointPool.pop()).bi=t,h.bj=e):h=new y(t,e),h.enabled=t.collisionResponse&&e.collisionResponse&&o.collisionResponse&&n.collisionResponse;var c=this.currentContactMaterial;h.restitution=c.restitution,h.setSpookParams(c.contactEquationStiffness,c.contactEquationRelaxation,this.world.dt);var d=o.material||t.material,v=n.material||e.material;return d&&v&&d.restitution>=0&&v.restitution>=0&&(h.restitution=d.restitution*v.restitution),h.si=r||o,h.sj=l||n,h},m.prototype.createFrictionEquationsFromContact=function(t,e){var o=t.bi,n=t.bj,r=t.si,l=t.sj,h=this.world,c=this.currentContactMaterial,d=c.friction,v=r.material||o.material,y=l.material||n.material;if(v&&y&&v.friction>=0&&y.friction>=0&&(d=v.friction*y.friction),d>0){var m=d*h.gravity.length(),w=o.invMass+n.invMass;w>0&&(w=1/w);var x=this.frictionEquationPool,B=x.length?x.pop():new f(o,n,m*w),E=x.length?x.pop():new f(o,n,m*w);return B.bi=E.bi=o,B.bj=E.bj=n,B.minForce=E.minForce=-m*w,B.maxForce=E.maxForce=m*w,B.ri.copy(t.ri),B.rj.copy(t.rj),E.ri.copy(t.ri),E.rj.copy(t.rj),t.ni.tangents(B.t,E.t),B.setSpookParams(c.frictionEquationStiffness,c.frictionEquationRelaxation,h.dt),E.setSpookParams(c.frictionEquationStiffness,c.frictionEquationRelaxation,h.dt),B.enabled=E.enabled=t.enabled,e.push(B,E),!0}return!1};var w=new h,x=new h,B=new h;m.prototype.createFrictionFromAverage=function(t){var e=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(e,this.frictionResult)&&1!==t){var o=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];w.setZero(),x.setZero(),B.setZero();for(var r=e.bi,i=(e.bj,0);i!==t;i++)(e=this.result[this.result.length-1-i]).bodyA!==r?(w.vadd(e.ni,w),x.vadd(e.ri,x),B.vadd(e.rj,B)):(w.vsub(e.ni,w),x.vadd(e.rj,x),B.vadd(e.ri,B));var l=1/t;x.scale(l,o.ri),B.scale(l,o.rj),n.ri.copy(o.ri),n.rj.copy(o.rj),w.normalize(),w.tangents(o.t,n.t)}};var E=new h,A=new h,S=new d,C=new d;m.prototype.getContacts=function(t,e,o,n,r,l,h){this.contactPointPool=r,this.frictionEquationPool=h,this.result=n,this.frictionResult=l;for(var c=S,d=C,v=E,y=A,f=0,m=t.length;f!==m;f++){var w=t[f],x=e[f],B=null;w.material&&x.material&&(B=o.getContactMaterial(w.material,x.material)||null);for(var i=0;i<w.shapes.length;i++){w.quaternion.mult(w.shapeOrientations[i],c),w.quaternion.vmult(w.shapeOffsets[i],v),v.vadd(w.position,v);for(var z=w.shapes[i],R=0;R<x.shapes.length;R++){x.quaternion.mult(x.shapeOrientations[R],d),x.quaternion.vmult(x.shapeOffsets[R],y),y.vadd(x.position,y);var M=x.shapes[R];if(!(v.distanceTo(y)>z.boundingSphereRadius+M.boundingSphereRadius)){var P=null;z.material&&M.material&&(P=o.getContactMaterial(z.material,M.material)||null),this.currentContactMaterial=P||B||o.defaultContactMaterial;var F=this[z.type|M.type];F&&(z.type<M.type?F.call(this,z,M,v,y,c,d,w,x,z,M):F.call(this,M,z,y,v,d,c,x,w,z,M))}}}}},m.prototype[r.types.BOX|r.types.BOX]=m.prototype.boxBox=function(t,e,o,n,r,l,h,c){t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,o,n,r,l,h,c,t,e)},m.prototype[r.types.BOX|r.types.CONVEXPOLYHEDRON]=m.prototype.boxConvex=function(t,e,o,n,r,l,h,c){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,o,n,r,l,h,c,t,e)},m.prototype[r.types.BOX|r.types.PARTICLE]=m.prototype.boxParticle=function(t,e,o,n,r,l,h,c){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,o,n,r,l,h,c,t,e)},m.prototype[r.types.SPHERE]=m.prototype.sphereSphere=function(t,e,o,n,r,l,h,c){var d=this.createContactEquation(h,c,t,e);n.vsub(o,d.ni),d.ni.normalize(),d.ri.copy(d.ni),d.rj.copy(d.ni),d.ri.mult(t.radius,d.ri),d.rj.mult(-e.radius,d.rj),d.ri.vadd(o,d.ri),d.ri.vsub(h.position,d.ri),d.rj.vadd(n,d.rj),d.rj.vsub(c.position,d.rj),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)};var z=new h,R=new h,M=new h;m.prototype[r.types.PLANE|r.types.TRIMESH]=m.prototype.planeTrimesh=function(t,e,o,n,r,l,d,v){var y=new h,f=z;f.set(0,0,1),r.vmult(f,f);for(var i=0;i<e.vertices.length/3;i++){e.getVertex(i,y);var m=new h;m.copy(y),c.pointToWorldFrame(n,l,m,y);var w=R;if(y.vsub(o,w),f.dot(w)<=0){var x=this.createContactEquation(d,v,t,e);x.ni.copy(f);var B=M;f.scale(w.dot(f),B),y.vsub(B,B),x.ri.copy(B),x.ri.vsub(d.position,x.ri),x.rj.copy(y),x.rj.vsub(v.position,x.rj),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}}};var P=new h,F=new h,V=(new h,new h),T=new h,N=new h,I=new h,W=new h,L=new h,j=new h,O=new h,k=new h,_=new h,U=new h,H=new n,D=[];m.prototype[r.types.SPHERE|r.types.TRIMESH]=m.prototype.sphereTrimesh=function(t,e,o,n,r,h,d,v){var y=N,f=I,m=W,w=L,x=j,B=O,E=H,A=T,S=F,C=D;c.pointToLocalFrame(n,h,o,x);var z=t.radius;E.lowerBound.set(x.x-z,x.y-z,x.z-z),E.upperBound.set(x.x+z,x.y+z,x.z+z),e.getTrianglesInAABB(E,C);for(var R=V,M=t.radius*t.radius,i=0;i<C.length;i++)for(var X=0;X<3;X++)e.getVertex(e.indices[3*C[i]+X],R),R.vsub(x,S),S.norm2()<=M&&(A.copy(R),c.pointToWorldFrame(n,h,A,R),R.vsub(o,S),(Q=this.createContactEquation(d,v,t,e)).ni.copy(S),Q.ni.normalize(),Q.ri.copy(Q.ni),Q.ri.scale(t.radius,Q.ri),Q.ri.vadd(o,Q.ri),Q.ri.vsub(d.position,Q.ri),Q.rj.copy(R),Q.rj.vsub(v.position,Q.rj),this.result.push(Q),this.createFrictionEquationsFromContact(Q,this.frictionResult));for(i=0;i<C.length;i++)for(X=0;X<3;X++){e.getVertex(e.indices[3*C[i]+X],y),e.getVertex(e.indices[3*C[i]+(X+1)%3],f),f.vsub(y,m),x.vsub(f,B);var G=B.dot(m);x.vsub(y,B);var Y=B.dot(m);if(Y>0&&G<0&&(x.vsub(y,B),w.copy(m),w.normalize(),Y=B.dot(w),w.scale(Y,B),B.vadd(y,B),(et=B.distanceTo(x))<t.radius)){var Q=this.createContactEquation(d,v,t,e);B.vsub(x,Q.ni),Q.ni.normalize(),Q.ni.scale(t.radius,Q.ri),c.pointToWorldFrame(n,h,B,B),B.vsub(v.position,Q.rj),c.vectorToWorldFrame(h,Q.ni,Q.ni),c.vectorToWorldFrame(h,Q.ri,Q.ri),this.result.push(Q),this.createFrictionEquationsFromContact(Q,this.frictionResult)}}for(var Z=k,K=_,J=U,$=P,tt=(i=0,C.length);i!==tt;i++){e.getTriangleVertices(C[i],Z,K,J),e.getNormal(C[i],$),x.vsub(Z,B);var et=B.dot($);$.scale(et,B),x.vsub(B,B),et=B.distanceTo(x),l.pointInTriangle(B,Z,K,J)&&et<t.radius&&(Q=this.createContactEquation(d,v,t,e),B.vsub(x,Q.ni),Q.ni.normalize(),Q.ni.scale(t.radius,Q.ri),c.pointToWorldFrame(n,h,B,B),B.vsub(v.position,Q.rj),c.vectorToWorldFrame(h,Q.ni,Q.ni),c.vectorToWorldFrame(h,Q.ri,Q.ri),this.result.push(Q),this.createFrictionEquationsFromContact(Q,this.frictionResult))}C.length=0};var X=new h,G=new h;m.prototype[r.types.SPHERE|r.types.PLANE]=m.prototype.spherePlane=function(t,e,o,n,r,l,h,c){var d=this.createContactEquation(h,c,t,e);if(d.ni.set(0,0,1),l.vmult(d.ni,d.ni),d.ni.negate(d.ni),d.ni.normalize(),d.ni.mult(t.radius,d.ri),o.vsub(n,X),d.ni.mult(d.ni.dot(X),G),X.vsub(G,d.rj),-X.dot(d.ni)<=t.radius){var v=d.ri,y=d.rj;v.vadd(o,v),v.vsub(h.position,v),y.vadd(n,y),y.vsub(c.position,y),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}};var Y=new h,Q=new h,Z=new h;function K(t,e,p){for(var o=null,n=t.length,i=0;i!==n;i++){var r=t[i],l=Y;t[(i+1)%n].vsub(r,l);var h=Q;l.cross(e,h);var c=Z;p.vsub(r,c);var d=h.dot(c);if(!(null===o||d>0&&!0===o||d<=0&&!1===o))return!1;null===o&&(o=d>0)}return!0}var J=new h,$=new h,tt=new h,et=new h,ot=[new h,new h,new h,new h,new h,new h],it=new h,nt=new h,st=new h,at=new h;m.prototype[r.types.SPHERE|r.types.BOX]=m.prototype.sphereBox=function(t,e,o,n,r,l,h,c){var d=this.v3pool,v=ot;o.vsub(n,J),e.getSideNormals(v,l);for(var y=t.radius,f=!1,m=nt,w=st,x=at,B=null,E=0,A=0,S=0,C=null,z=0,R=v.length;z!==R&&!1===f;z++){var M=$;M.copy(v[z]);var P=M.norm();M.normalize();var F=J.dot(M);if(F<P+y&&F>0){var V=tt,T=et;V.copy(v[(z+1)%3]),T.copy(v[(z+2)%3]);var h1=V.norm(),h2=T.norm();V.normalize(),T.normalize();var N=J.dot(V),I=J.dot(T);if(N<h1&&N>-h1&&I<h2&&I>-h2){var W=Math.abs(F-P-y);(null===C||W<C)&&(C=W,A=N,S=I,B=P,m.copy(M),w.copy(V),x.copy(T),E++)}}}if(E){f=!0;var L=this.createContactEquation(h,c,t,e);m.mult(-y,L.ri),L.ni.copy(m),L.ni.negate(L.ni),m.mult(B,m),w.mult(A,w),m.vadd(w,m),x.mult(S,x),m.vadd(x,L.rj),L.ri.vadd(o,L.ri),L.ri.vsub(h.position,L.ri),L.rj.vadd(n,L.rj),L.rj.vsub(c.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}for(var j=d.get(),O=it,k=0;2!==k&&!f;k++)for(var _=0;2!==_&&!f;_++)for(var U=0;2!==U&&!f;U++)j.set(0,0,0),k?j.vadd(v[0],j):j.vsub(v[0],j),_?j.vadd(v[1],j):j.vsub(v[1],j),U?j.vadd(v[2],j):j.vsub(v[2],j),n.vadd(j,O),O.vsub(o,O),O.norm2()<y*y&&(f=!0,(L=this.createContactEquation(h,c,t,e)).ri.copy(O),L.ri.normalize(),L.ni.copy(L.ri),L.ri.mult(y,L.ri),L.rj.copy(j),L.ri.vadd(o,L.ri),L.ri.vsub(h.position,L.ri),L.rj.vadd(n,L.rj),L.rj.vsub(c.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult));d.release(j),j=null;var H=d.get(),D=d.get(),X=(L=d.get(),d.get()),G=(W=d.get(),v.length);for(k=0;k!==G&&!f;k++)for(_=0;_!==G&&!f;_++)if(k%3!=_%3){v[_].cross(v[k],H),H.normalize(),v[k].vadd(v[_],D),L.copy(o),L.vsub(D,L),L.vsub(n,L);var Y=L.dot(H);for(H.mult(Y,X),U=0;U===k%3||U===_%3;)U++;W.copy(o),W.vsub(X,W),W.vsub(D,W),W.vsub(n,W);var Q=Math.abs(Y),Z=W.norm();if(Q<v[U].norm()&&Z<y){f=!0;var K=this.createContactEquation(h,c,t,e);D.vadd(X,K.rj),K.rj.copy(K.rj),W.negate(K.ni),K.ni.normalize(),K.ri.copy(K.rj),K.ri.vadd(n,K.ri),K.ri.vsub(o,K.ri),K.ri.normalize(),K.ri.mult(y,K.ri),K.ri.vadd(o,K.ri),K.ri.vsub(h.position,K.ri),K.rj.vadd(n,K.rj),K.rj.vsub(c.position,K.rj),this.result.push(K),this.createFrictionEquationsFromContact(K,this.frictionResult)}}d.release(H,D,L,X,W)};var lt=new h,ht=new h,pt=new h,ct=new h,ut=new h,vt=new h,yt=new h,ft=new h,mt=new h,wt=new h;m.prototype[r.types.SPHERE|r.types.CONVEXPOLYHEDRON]=m.prototype.sphereConvex=function(t,e,o,n,r,l,h,c){var d=this.v3pool;o.vsub(n,lt);for(var v=e.faceNormals,y=e.faces,f=e.vertices,m=t.radius,i=0;i!==f.length;i++){var w=f[i],x=ut;l.vmult(w,x),n.vadd(x,x);var B=ct;if(x.vsub(o,B),B.norm2()<m*m)return E=!0,(L=this.createContactEquation(h,c,t,e)).ri.copy(B),L.ri.normalize(),L.ni.copy(L.ri),L.ri.mult(m,L.ri),x.vsub(n,L.rj),L.ri.vadd(o,L.ri),L.ri.vsub(h.position,L.ri),L.rj.vadd(n,L.rj),L.rj.vsub(c.position,L.rj),this.result.push(L),void this.createFrictionEquationsFromContact(L,this.frictionResult)}for(var E=!1,A=(i=0,y.length);i!==A&&!1===E;i++){var S=v[i],C=y[i],z=vt;l.vmult(S,z);var R=yt;l.vmult(f[C[0]],R),R.vadd(n,R);var M=ft;z.mult(-m,M),o.vadd(M,M);var P=mt;M.vsub(R,P);var F=P.dot(z),V=wt;if(o.vsub(R,V),F<0&&V.dot(z)>0){for(var T=[],N=0,I=C.length;N!==I;N++){var W=d.get();l.vmult(f[C[N]],W),n.vadd(W,W),T.push(W)}if(K(T,z,o)){E=!0;var L=this.createContactEquation(h,c,t,e);z.mult(-m,L.ri),z.negate(L.ni);var j=d.get();z.mult(-F,j);var O=d.get();z.mult(-m,O),o.vsub(n,L.rj),L.rj.vadd(O,L.rj),L.rj.vadd(j,L.rj),L.rj.vadd(n,L.rj),L.rj.vsub(c.position,L.rj),L.ri.vadd(o,L.ri),L.ri.vsub(h.position,L.ri),d.release(j),d.release(O),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult),N=0;for(var k=T.length;N!==k;N++)d.release(T[N]);return}for(N=0;N!==C.length;N++){var _=d.get(),U=d.get();l.vmult(f[C[(N+1)%C.length]],_),l.vmult(f[C[(N+2)%C.length]],U),n.vadd(_,_),n.vadd(U,U);var H=ht;U.vsub(_,H);var D=pt;H.unit(D);var p=d.get(),X=d.get();o.vsub(_,X);var G=X.dot(D);D.mult(G,p),p.vadd(_,p);var Y=d.get();if(p.vsub(o,Y),G>0&&G*G<H.norm2()&&Y.norm2()<m*m){for(L=this.createContactEquation(h,c,t,e),p.vsub(n,L.rj),p.vsub(o,L.ni),L.ni.normalize(),L.ni.mult(m,L.ri),L.rj.vadd(n,L.rj),L.rj.vsub(c.position,L.rj),L.ri.vadd(o,L.ri),L.ri.vsub(h.position,L.ri),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult),N=0,k=T.length;N!==k;N++)d.release(T[N]);return d.release(_),d.release(U),d.release(p),d.release(Y),void d.release(X)}d.release(_),d.release(U),d.release(p),d.release(Y),d.release(X)}for(N=0,k=T.length;N!==k;N++)d.release(T[N])}}},new h,new h,m.prototype[r.types.PLANE|r.types.BOX]=m.prototype.planeBox=function(t,e,o,n,r,l,h,c){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.planeConvex(t,e.convexPolyhedronRepresentation,o,n,r,l,h,c)};var xt=new h,gt=new h,bt=new h,Bt=new h;m.prototype[r.types.PLANE|r.types.CONVEXPOLYHEDRON]=m.prototype.planeConvex=function(t,e,o,n,r,l,h,c){var d=xt,v=gt;v.set(0,0,1),r.vmult(v,v);for(var y=0,f=bt,i=0;i!==e.vertices.length;i++)if(d.copy(e.vertices[i]),l.vmult(d,d),n.vadd(d,d),d.vsub(o,f),v.dot(f)<=0){var m=this.createContactEquation(h,c,t,e),w=Bt;v.mult(v.dot(f),w),d.vsub(w,w),w.vsub(o,m.ri),m.ni.copy(v),d.vsub(n,m.rj),m.ri.vadd(o,m.ri),m.ri.vsub(h.position,m.ri),m.rj.vadd(n,m.rj),m.rj.vsub(c.position,m.rj),this.result.push(m),y++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&y&&this.createFrictionFromAverage(y)};var Et=new h,At=new h;m.prototype[r.types.CONVEXPOLYHEDRON]=m.prototype.convexConvex=function(t,e,o,n,r,l,h,c,d,v,y,f){var m=Et;if(!(o.distanceTo(n)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,o,r,n,l,m,y,f)){var w=[],q=At;t.clipAgainstHull(o,r,e,n,l,m,-100,100,w);for(var x=0,B=0;B!==w.length;B++){var E=this.createContactEquation(h,c,t,e,d,v),A=E.ri,S=E.rj;m.negate(E.ni),w[B].normal.negate(q),q.mult(w[B].depth,q),w[B].point.vadd(q,A),S.copy(w[B].point),A.vsub(o,A),S.vsub(n,S),A.vadd(o,A),A.vsub(h.position,A),S.vadd(n,S),S.vsub(c.position,S),this.result.push(E),x++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(E,this.frictionResult)}this.enableFrictionReduction&&x&&this.createFrictionFromAverage(x)}};var St=new h,Ct=new h,zt=new h;m.prototype[r.types.PLANE|r.types.PARTICLE]=m.prototype.planeParticle=function(t,e,o,n,r,l,h,c){var d=St;d.set(0,0,1),h.quaternion.vmult(d,d);var v=Ct;if(n.vsub(h.position,v),d.dot(v)<=0){var y=this.createContactEquation(c,h,e,t);y.ni.copy(d),y.ni.negate(y.ni),y.ri.set(0,0,0);var f=zt;d.mult(d.dot(n),f),n.vsub(f,f),y.rj.copy(f),this.result.push(y),this.createFrictionEquationsFromContact(y,this.frictionResult)}};var qt=new h;m.prototype[r.types.PARTICLE|r.types.SPHERE]=m.prototype.sphereParticle=function(t,e,o,n,r,l,h,c){var d=qt;if(d.set(0,0,1),n.vsub(o,d),d.norm2()<=t.radius*t.radius){var v=this.createContactEquation(c,h,e,t);d.normalize(),v.rj.copy(d),v.rj.mult(t.radius,v.rj),v.ni.copy(d),v.ni.negate(v.ni),v.ri.set(0,0,0),this.result.push(v),this.createFrictionEquationsFromContact(v,this.frictionResult)}};var Rt=new d,Mt=new h,Pt=(new h,new h),Ft=new h,Vt=new h;m.prototype[r.types.PARTICLE|r.types.CONVEXPOLYHEDRON]=m.prototype.convexParticle=function(t,e,o,n,r,l,h,c){var d=-1,v=Pt,y=Vt,f=null,m=Mt;if(m.copy(n),m.vsub(o,m),r.conjugate(Rt),Rt.vmult(m,m),t.pointIsInside(m)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(o,r),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(r);for(var i=0,w=t.faces.length;i!==w;i++){var x=[t.worldVertices[t.faces[i][0]]],B=t.worldFaceNormals[i];n.vsub(x[0],Ft);var E=-B.dot(Ft);(null===f||Math.abs(E)<Math.abs(f))&&(f=E,d=i,v.copy(B))}if(-1!==d){var A=this.createContactEquation(c,h,e,t);v.mult(f,y),y.vadd(n,y),y.vsub(o,y),A.rj.copy(y),v.negate(A.ni),A.ri.set(0,0,0);var S=A.ri,C=A.rj;S.vadd(n,S),S.vsub(c.position,S),C.vadd(o,C),C.vsub(h.position,C),this.result.push(A),this.createFrictionEquationsFromContact(A,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},m.prototype[r.types.BOX|r.types.HEIGHTFIELD]=m.prototype.boxHeightfield=function(t,e,o,n,r,l,h,c){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,e,o,n,r,l,h,c)};var Tt=new h,Nt=new h,It=[0];m.prototype[r.types.CONVEXPOLYHEDRON|r.types.HEIGHTFIELD]=m.prototype.convexHeightfield=function(t,e,o,n,r,l,h,d){var data=e.data,v=e.elementSize,y=t.boundingSphereRadius,f=Nt,m=It,w=Tt;c.pointToLocalFrame(n,l,o,w);var x=Math.floor((w.x-y)/v)-1,B=Math.ceil((w.x+y)/v)+1,E=Math.floor((w.y-y)/v)-1,A=Math.ceil((w.y+y)/v)+1;if(!(B<0||A<0||x>data.length||E>data[0].length)){x<0&&(x=0),B<0&&(B=0),E<0&&(E=0),A<0&&(A=0),x>=data.length&&(x=data.length-1),B>=data.length&&(B=data.length-1),A>=data[0].length&&(A=data[0].length-1),E>=data[0].length&&(E=data[0].length-1);var S=[];e.getRectMinMax(x,E,B,A,S);var C=S[0],z=S[1];if(!(w.z-y>z||w.z+y<C))for(var i=x;i<B;i++)for(var R=E;R<A;R++)e.getConvexTrianglePillar(i,R,!1),c.pointToWorldFrame(n,l,e.pillarOffset,f),o.distanceTo(f)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,e.pillarConvex,o,f,r,l,h,d,null,null,m,null),e.getConvexTrianglePillar(i,R,!0),c.pointToWorldFrame(n,l,e.pillarOffset,f),o.distanceTo(f)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,e.pillarConvex,o,f,r,l,h,d,null,null,m,null)}};var Wt=new h,Lt=new h;m.prototype[r.types.SPHERE|r.types.HEIGHTFIELD]=m.prototype.sphereHeightfield=function(t,e,o,n,r,l,h,d){var data=e.data,v=t.radius,y=e.elementSize,f=Lt,m=Wt;c.pointToLocalFrame(n,l,o,m);var w=Math.floor((m.x-v)/y)-1,x=Math.ceil((m.x+v)/y)+1,B=Math.floor((m.y-v)/y)-1,E=Math.ceil((m.y+v)/y)+1;if(!(x<0||E<0||w>data.length||E>data[0].length)){w<0&&(w=0),x<0&&(x=0),B<0&&(B=0),E<0&&(E=0),w>=data.length&&(w=data.length-1),x>=data.length&&(x=data.length-1),E>=data[0].length&&(E=data[0].length-1),B>=data[0].length&&(B=data[0].length-1);var A=[];e.getRectMinMax(w,B,x,E,A);var S=A[0],C=A[1];if(!(m.z-v>C||m.z+v<S))for(var z=this.result,i=w;i<x;i++)for(var R=B;R<E;R++){var M=z.length;if(e.getConvexTrianglePillar(i,R,!1),c.pointToWorldFrame(n,l,e.pillarOffset,f),o.distanceTo(f)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,e.pillarConvex,o,f,r,l,h,d),e.getConvexTrianglePillar(i,R,!0),c.pointToWorldFrame(n,l,e.pillarOffset,f),o.distanceTo(f)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,e.pillarConvex,o,f,r,l,h,d),z.length-M>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(t,e,o){e.exports=S;var n=t("../shapes/Shape"),r=t("../math/Vec3"),l=t("../math/Quaternion"),h=t("../solver/GSSolver"),c=(t("../utils/Vec3Pool"),t("../equations/ContactEquation"),t("../equations/FrictionEquation"),t("./Narrowphase")),d=t("../utils/EventTarget"),v=t("../collision/ArrayCollisionMatrix"),y=t("../material/Material"),f=t("../material/ContactMaterial"),m=t("../objects/Body"),w=t("../utils/TupleDictionary"),x=t("../collision/RaycastResult"),B=t("../collision/AABB"),E=t("../collision/Ray"),A=t("../collision/NaiveBroadphase");function S(){d.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new r,this.broadphase=new A,this.bodies=[],this.solver=new h,this.constraints=[],this.narrowphase=new c(this),this.collisionMatrix=new v,this.collisionMatrixPrevious=new v,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new w,this.defaultMaterial=new y("default"),this.defaultContactMaterial=new f(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}S.prototype=new d,new B;var C=new E;if(S.prototype.getContactMaterial=function(t,e){return this.contactMaterialTable.get(t.id,e.id)},S.prototype.numObjects=function(){return this.bodies.length},S.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset()},S.prototype.add=S.prototype.addBody=function(body){-1===this.bodies.indexOf(body)&&(body.index=this.bodies.length,this.bodies.push(body),body.world=this,body.initPosition.copy(body.position),body.initVelocity.copy(body.velocity),body.timeLastSleepy=this.time,body instanceof m&&(body.initAngularVelocity.copy(body.angularVelocity),body.initQuaternion.copy(body.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=body,this.dispatchEvent(this.addBodyEvent))},S.prototype.addConstraint=function(t){this.constraints.push(t)},S.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},S.prototype.rayTest=function(t,e,o){o instanceof x?this.raycastClosest(t,e,{skipBackfaces:!0},o):this.raycastAll(t,e,{skipBackfaces:!0},o)},S.prototype.raycastAll=function(t,e,o,n){return o.mode=E.ALL,o.from=t,o.to=e,o.callback=n,C.intersectWorld(this,o)},S.prototype.raycastAny=function(t,e,o,n){return o.mode=E.ANY,o.from=t,o.to=e,o.result=n,C.intersectWorld(this,o)},S.prototype.raycastClosest=function(t,e,o,n){return o.mode=E.CLOSEST,o.from=t,o.to=e,o.result=n,C.intersectWorld(this,o)},S.prototype.remove=function(body){body.world=null;var t=this.bodies.length-1,e=this.bodies,o=e.indexOf(body);if(-1!==o){e.splice(o,1);for(var i=0;i!==e.length;i++)e[i].index=i;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=body,this.dispatchEvent(this.removeBodyEvent)}},S.prototype.removeBody=S.prototype.remove,S.prototype.addMaterial=function(t){this.materials.push(t)},S.prototype.addContactMaterial=function(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)},"undefined"==typeof performance&&(performance={}),!performance.now){var z=Date.now();performance.timing&&performance.timing.navigationStart&&(z=performance.timing.navigationStart),performance.now=function(){return Date.now()-z}}var R=new r;S.prototype.step=function(dt,t,e){if(e=e||10,0===(t=t||0))this.internalStep(dt),this.time+=dt;else{var o=Math.floor((this.time+t)/dt)-Math.floor(this.time/dt);o=Math.min(o,e);for(var n=performance.now(),i=0;i!==o&&(this.internalStep(dt),!(performance.now()-n>1e3*dt));i++);this.time+=t;for(var r=this.time%dt/dt,l=R,h=this.bodies,c=0;c!==h.length;c++){var b=h[c];b.type!==m.STATIC&&b.sleepState!==m.SLEEPING?(b.position.vsub(b.previousPosition,l),l.scale(r,l),b.position.vadd(l,b.interpolatedPosition)):(b.interpolatedPosition.copy(b.position),b.interpolatedQuaternion.copy(b.quaternion))}}};var M={type:"postStep"},P={type:"preStep"},F={type:"collide",body:null,contact:null},V=[],T=[],N=[],I=[],W=(new r,new r,new r,new r,new r,new r,new r,new r,new r,new l,new l),L=new l,j=new r;S.prototype.internalStep=function(dt){this.dt=dt;var t,e=this.contacts,o=N,r=I,l=this.numObjects(),h=this.bodies,c=this.solver,d=this.gravity,v=this.doProfiling,y=this.profile,f=m.DYNAMIC,w=this.constraints,x=T,B=(d.norm(),d.x),E=d.y,A=d.z,i=0;for(v&&(t=performance.now()),i=0;i!==l;i++)if((X=h[i]).type&f){var S=X.force,C=X.mass;S.x+=C*B,S.y+=C*E,S.z+=C*A}i=0;for(var z=this.subsystems.length;i!==z;i++)this.subsystems[i].update();v&&(t=performance.now()),o.length=0,r.length=0,this.broadphase.collisionPairs(this,o,r),v&&(y.broadphase=performance.now()-t);var R=w.length;for(i=0;i!==R;i++)if(!(Y=w[i]).collideConnected)for(var O=o.length-1;O>=0;O-=1)(Y.bodyA===o[O]&&Y.bodyB===r[O]||Y.bodyB===o[O]&&Y.bodyA===r[O])&&(o.splice(O,1),r.splice(O,1));this.collisionMatrixTick(),v&&(t=performance.now());var k=V,_=e.length;for(i=0;i!==_;i++)k.push(e[i]);e.length=0;var U=this.frictionEquations.length;for(i=0;i!==U;i++)x.push(this.frictionEquations[i]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(o,r,this,e,k,this.frictionEquations,x),v&&(y.narrowphase=performance.now()-t),v&&(t=performance.now()),i=0;i<this.frictionEquations.length;i++)c.addEquation(this.frictionEquations[i]);for(var H=e.length,D=0;D!==H;D++){var X=(Y=e[D]).bi,G=Y.bj;Y.si,Y.sj,(X.material&&G.material&&this.getContactMaterial(X.material,G.material)||this.defaultContactMaterial).friction,X.material&&G.material&&(X.material.friction>=0&&G.material.friction>=0&&(X.material.friction,G.material.friction),X.material.restitution>=0&&G.material.restitution>=0&&(Y.restitution=X.material.restitution*G.material.restitution)),c.addEquation(Y),X.allowSleep&&X.type===m.DYNAMIC&&X.sleepState===m.SLEEPING&&G.sleepState===m.AWAKE&&G.type!==m.STATIC&&G.velocity.norm2()+G.angularVelocity.norm2()>=2*Math.pow(G.sleepSpeedLimit,2)&&(X._wakeUpAfterNarrowphase=!0),G.allowSleep&&G.type===m.DYNAMIC&&G.sleepState===m.SLEEPING&&X.sleepState===m.AWAKE&&X.type!==m.STATIC&&X.velocity.norm2()+X.angularVelocity.norm2()>=2*Math.pow(X.sleepSpeedLimit,2)&&(G._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(X,G,!0),this.collisionMatrixPrevious.get(X,G)||(F.body=G,F.contact=Y,X.dispatchEvent(F),F.body=X,G.dispatchEvent(F))}for(v&&(y.makeContactConstraints=performance.now()-t,t=performance.now()),i=0;i!==l;i++)(X=h[i])._wakeUpAfterNarrowphase&&(X.wakeUp(),X._wakeUpAfterNarrowphase=!1);for(R=w.length,i=0;i!==R;i++){var Y;(Y=w[i]).update(),O=0;for(var Q=Y.equations.length;O!==Q;O++){var Z=Y.equations[O];c.addEquation(Z)}}c.solve(dt,this),v&&(y.solve=performance.now()-t),c.removeAllEquations();var K=Math.pow;for(i=0;i!==l;i++)if((X=h[i]).type&f){var J=K(1-X.linearDamping,dt),$=X.velocity;$.mult(J,$);var tt=X.angularVelocity;if(tt){var et=K(1-X.angularDamping,dt);tt.mult(et,tt)}}for(this.dispatchEvent(P),i=0;i!==l;i++)(X=h[i]).preStep&&X.preStep.call(X);v&&(t=performance.now());var ot=W,it=L,nt=this.stepnumber,st=m.DYNAMIC|m.KINEMATIC,at=nt%(this.quatNormalizeSkip+1)==0,lt=this.quatNormalizeFast,ht=.5*dt;for(n.types.PLANE,n.types.CONVEXPOLYHEDRON,i=0;i!==l;i++){var b=h[i],pt=b.force,ct=b.torque;if(b.type&st&&b.sleepState!==m.SLEEPING){var ut=b.velocity,vt=b.angularVelocity,yt=b.position,ft=b.quaternion,mt=b.invMass,wt=b.invInertiaWorld;ut.x+=pt.x*mt*dt,ut.y+=pt.y*mt*dt,ut.z+=pt.z*mt*dt,b.angularVelocity&&(wt.vmult(ct,j),j.mult(dt,j),j.vadd(vt,vt)),yt.x+=ut.x*dt,yt.y+=ut.y*dt,yt.z+=ut.z*dt,b.angularVelocity&&(ot.set(vt.x,vt.y,vt.z,0),ot.mult(ft,it),ft.x+=ht*it.x,ft.y+=ht*it.y,ft.z+=ht*it.z,ft.w+=ht*it.w,at&&(lt?ft.normalizeFast():ft.normalize())),b.aabb&&(b.aabbNeedsUpdate=!0),b.updateInertiaWorld&&b.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,v&&(y.integrate=performance.now()-t),this.time+=dt,this.stepnumber+=1,this.dispatchEvent(M),i=0;i!==l;i++){var xt=(X=h[i]).postStep;xt&&xt.call(X)}if(this.allowSleep)for(i=0;i!==l;i++)h[i].sleepTick(this.time)},S.prototype.clearForces=function(){for(var t=this.bodies,e=t.length,i=0;i!==e;i++){var b=t[i];b.force,b.torque,b.force.set(0,0,0),b.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)}}]);